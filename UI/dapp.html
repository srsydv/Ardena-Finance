<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ardena Finance - DApp Interface</title>
    <link rel="icon" href="/images/ardena-finance-logo.png" />
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --success-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --danger-gradient: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            --info-gradient: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            --warning-gradient: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            --dark-gradient: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            --glass-bg: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.2);
            --shadow-light: 0 8px 32px rgba(0, 0, 0, 0.1);
            --shadow-medium: 0 15px 40px rgba(0, 0, 0, 0.15);
            --shadow-heavy: 0 25px 50px rgba(0, 0, 0, 0.2);
            --border-radius: 20px;
            --border-radius-small: 12px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            color: #e8e8e8;
            line-height: 1.6;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 80%, rgba(0, 150, 255, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(0, 255, 150, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(150, 0, 255, 0.1) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
            position: relative;
            z-index: 1;
        }

        .header {
            text-align: center;
            margin-bottom: 3rem;
            padding: 2rem;
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border-radius: var(--border-radius);
            border: 1px solid var(--glass-border);
            box-shadow: var(--shadow-light);
        }

        .logo-container {
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 0.5rem;
            text-align: center;
        }

        .logo-image-container {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0.5rem;
            background: transparent;
            border-radius: 8px;
            border: none;
            transition: all 0.2s ease;
        }

        .logo-image-container:hover {
            transform: none;
        }

        .logo-image {
            height: 50px;
            width: auto;
            max-width: 120px;
            filter: none;
            transition: none;
        }

        .logo-image:hover {
            filter: none;
        }

        .logo-text h1 {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, #00d4ff 0%, #0099cc 50%, #0066ff 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin: 0;
            text-shadow: none;
            position: relative;
            overflow: hidden;
        }

        .tagline {
            font-size: 1rem;
            color: rgba(232, 232, 232, 0.7);
            margin: 0.5rem 0 0 0;
            font-weight: 400;
            letter-spacing: 0.3px;
            text-align: center;
        }

        .flying-star {
            position: absolute;
            top: 20px;
            font-size: 2.5rem;
            animation: flyAcross 8s ease-in-out infinite, twinkle 2s ease-in-out infinite;
            z-index: 10;
            pointer-events: none;
            filter: drop-shadow(0 0 20px rgba(255, 215, 0, 0.8)) drop-shadow(0 0 40px rgba(255, 255, 255, 0.6));
            color: #FFD700;
            text-shadow: 0 0 15px rgba(255, 215, 0, 1), 0 0 30px rgba(255, 255, 255, 0.8);
            transform: rotate(0deg);
        }


        @keyframes flyAcross {
            0% {
                left: -50px;
                opacity: 0;
                transform: translateY(0px) rotate(0deg) scale(0.8);
            }
            10% {
                opacity: 1;
                transform: translateY(-5px) rotate(45deg) scale(1);
            }
            25% {
                transform: translateY(3px) rotate(90deg) scale(1.1);
            }
            50% {
                left: 50%;
                transform: translateY(-3px) rotate(180deg) scale(1);
            }
            75% {
                transform: translateY(5px) rotate(270deg) scale(1.1);
            }
            90% {
                opacity: 1;
                transform: translateY(-2px) rotate(360deg) scale(1);
            }
            100% {
                left: calc(100% + 50px);
                opacity: 0;
                transform: translateY(0px) rotate(360deg) scale(0.8);
            }
        }

        @keyframes twinkle {
            0%, 100% {
                filter: drop-shadow(0 0 20px rgba(255, 215, 0, 0.8)) drop-shadow(0 0 40px rgba(255, 255, 255, 0.6));
            }
            50% {
                filter: drop-shadow(0 0 30px rgba(255, 215, 0, 1)) drop-shadow(0 0 60px rgba(255, 255, 255, 0.8));
            }
        }


        .header p {
            font-size: 1.3rem;
            color: rgba(232, 232, 232, 0.8);
            font-weight: 500;
        }

        .wallet-section {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border-radius: var(--border-radius);
            padding: 2rem;
            margin-bottom: 2rem;
            text-align: center;
            border: 1px solid var(--glass-border);
            box-shadow: var(--shadow-light);
            transition: var(--transition);
        }

        .wallet-section:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-medium);
        }

        .wallet-section h2 {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            color: #e8e8e8;
        }

        .wallet-section .wallet-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding: 1.5rem 2rem;
            background: linear-gradient(135deg, 
                rgba(255, 255, 255, 0.1) 0%, 
                rgba(255, 255, 255, 0.05) 50%, 
                rgba(0, 0, 0, 0.1) 100%);
            border-radius: 20px;
            backdrop-filter: blur(20px);
            position: relative;
            overflow: hidden;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.1),
                0 0 0 1px rgba(255, 255, 255, 0.05);
        }

        .wallet-left {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .wallet-section .wallet-info::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, 
                #00d4ff 0%, 
                #0099cc 25%, 
                #0066ff 50%, 
                #8b5cf6 75%, 
                #00d4ff 100%);
            background-size: 200% 100%;
            opacity: 0;
            transition: all 0.4s ease;
            animation: gradientShift 3s ease-in-out infinite;
        }

        .wallet-section .wallet-info.connected::before {
            opacity: 1;
        }

        .wallet-section .wallet-info::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, 
                rgba(0, 212, 255, 0.1) 0%, 
                transparent 70%);
            opacity: 0;
            transition: opacity 0.4s ease;
            pointer-events: none;
        }

        .wallet-section .wallet-info:hover::after {
            opacity: 1;
        }

        .wallet-section .wallet-info:hover {
            transform: translateY(-4px) scale(1.02);
            box-shadow: 
                0 20px 60px rgba(0, 0, 0, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.2),
                0 0 0 1px rgba(0, 212, 255, 0.3),
                0 0 40px rgba(0, 212, 255, 0.2);
            border-color: rgba(0, 212, 255, 0.4);
        }

        /* Manager Actions Grid Layout */
        .manager-actions-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.5rem;
            align-items: stretch;
            margin-bottom: 2rem;
        }

        /* Manager Section Styles */
        .manager-section {
            background: linear-gradient(135deg, 
                rgba(255, 255, 255, 0.1) 0%, 
                rgba(255, 255, 255, 0.05) 50%, 
                rgba(0, 0, 0, 0.1) 100%);
            border-radius: 20px;
            padding: 1.5rem;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
            min-height: 400px;
        }

        .manager-section:hover {
            transform: translateY(-5px);
            box-shadow: 
                0 12px 40px rgba(0, 0, 0, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
            border-color: rgba(0, 212, 255, 0.3);
        }

        .manager-section h4 {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: #e8e8e8;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .section-content {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            flex: 1;
            justify-content: space-between;
        }

        .section-content p {
            margin: 0;
            color: rgba(232, 232, 232, 0.9);
            font-size: 0.95rem;
        }

        /* Small Form Group Styles */
        .form-group-small {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .form-group-small label {
            font-size: 0.85rem;
            font-weight: 500;
            color: rgba(232, 232, 232, 0.8);
            margin-bottom: 0.25rem;
        }

        .form-group-small input {
            padding: 0.6rem 0.8rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.05);
            color: #e8e8e8;
            font-size: 0.85rem;
            transition: all 0.3s ease;
        }

        .form-group-small input:focus {
            outline: none;
            border-color: #00d4ff;
            box-shadow: 0 0 0 2px rgba(0, 212, 255, 0.2);
            background: rgba(255, 255, 255, 0.08);
        }

        .form-group-small input::placeholder {
            color: rgba(232, 232, 232, 0.4);
        }

        /* Responsive Design for Manager Actions */
        @media (max-width: 1400px) {
            .manager-actions-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 1.25rem;
            }
        }

        @media (max-width: 1000px) {
            .manager-actions-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            
            .manager-section {
                min-height: auto;
            }
        }

        @media (max-width: 768px) {
            .manager-actions-grid {
                gap: 0.75rem;
            }
            
            .manager-section {
                padding: 1rem;
                min-height: auto;
            }
            
            .manager-section h4 {
                font-size: 1rem;
            }
        }

        @keyframes gradientShift {
            0%, 100% {
                background-position: 0% 50%;
            }
            50% {
                background-position: 100% 50%;
            }
        }

        .wallet-section .wallet-address {
            font-family: 'Courier New', monospace;
            background: rgba(0, 0, 0, 0.4);
            padding: 0.75rem 1rem;
            border-radius: 6px;
            word-break: break-all;
            overflow-wrap: anywhere;
            font-size: 0.85rem;
            color: #b3d8ff;
            border: 1px dashed rgba(79,172,254,0.5);
            max-width: 100%;
            display: block;
            margin: 0.5rem 0;
            line-height: 1.4;
            box-sizing: border-box;
            transition: all 0.3s ease;
            position: relative;
            backdrop-filter: blur(5px);
        }

        .wallet-section .wallet-address::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, 
                transparent, 
                rgba(0, 212, 255, 0.2), 
                rgba(139, 92, 246, 0.2),
                transparent);
            transition: left 0.8s ease;
        }

        .wallet-section .wallet-address::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, 
                rgba(0, 212, 255, 0.05) 0%, 
                transparent 50%, 
                rgba(139, 92, 246, 0.05) 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .wallet-section .wallet-address:hover::before {
            left: 100%;
        }

        .wallet-section .wallet-address:hover::after {
            opacity: 1;
        }

        .wallet-section .wallet-address:hover {
            transform: translateY(-2px);
            border-color: rgba(79,172,254,0.8);
            background: rgba(0, 0, 0, 0.5);
            box-shadow: 
                0 4px 15px rgba(0, 0, 0, 0.3),
                0 2px 8px rgba(79,172,254, 0.2);
            color: #b3d8ff;
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 600;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 0.5rem 1rem;
            border-radius: 12px;
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .connection-status::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, 
                transparent, 
                rgba(255, 255, 255, 0.1), 
                transparent);
            transition: left 0.6s ease;
        }

        .connection-status:hover::before {
            left: 100%;
        }

        .connection-status.not-connected {
            color: #ff6b6b;
            border-color: rgba(255, 107, 107, 0.3);
            box-shadow: 0 0 20px rgba(255, 107, 107, 0.1);
        }

        .connection-status.connected {
            color: #51cf66;
            border-color: rgba(81, 207, 102, 0.3);
            box-shadow: 0 0 20px rgba(81, 207, 102, 0.1);
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            position: relative;
            animation: pulse 2s infinite;
        }

        .status-indicator::before {
            content: '';
            position: absolute;
            top: -4px;
            left: -4px;
            right: -4px;
            bottom: -4px;
            border-radius: 50%;
            opacity: 0.3;
            animation: ripple 2s infinite;
        }

        .status-indicator.not-connected {
            background: linear-gradient(135deg, #ff6b6b, #ff5252);
            box-shadow: 0 0 10px rgba(255, 107, 107, 0.5);
        }

        .status-indicator.not-connected::before {
            background: #ff6b6b;
        }

        .status-indicator.connected {
            background: linear-gradient(135deg, #51cf66, #40c057);
            box-shadow: 0 0 10px rgba(81, 207, 102, 0.5);
        }

        .status-indicator.connected::before {
            background: #51cf66;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
                transform: scale(1);
            }
            50% {
                opacity: 0.7;
                transform: scale(1.1);
            }
        }

        @keyframes ripple {
            0% {
                transform: scale(0.8);
                opacity: 0.3;
            }
            100% {
                transform: scale(2);
                opacity: 0;
            }
        }

        .role-badges {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .role-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 16px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }

        .role-badge::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, 
                transparent, 
                rgba(255, 255, 255, 0.2), 
                transparent);
            transition: left 0.6s ease;
        }

        .role-badge:hover::before {
            left: 100%;
        }

        .role-badge.role-user {
            background: linear-gradient(135deg, 
                rgba(108, 117, 125, 0.3) 0%, 
                rgba(108, 117, 125, 0.1) 100%);
            color: #adb5bd;
            border: 1px solid rgba(108, 117, 125, 0.4);
        }

        .role-badge.role-user:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(108, 117, 125, 0.3);
            border-color: rgba(108, 117, 125, 0.6);
        }

        .role-badge.role-manager {
            background: linear-gradient(135deg, 
                rgba(0, 212, 255, 0.3) 0%, 
                rgba(0, 212, 255, 0.1) 100%);
            color: #00d4ff;
            border: 1px solid rgba(0, 212, 255, 0.4);
            box-shadow: 0 4px 15px rgba(0, 212, 255, 0.2);
        }

        .role-badge.role-manager:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 212, 255, 0.4);
            border-color: rgba(0, 212, 255, 0.6);
        }

        .role-badge.role-keeper {
            background: linear-gradient(135deg, 
                rgba(40, 167, 69, 0.3) 0%, 
                rgba(40, 167, 69, 0.1) 100%);
            color: #28a745;
            border: 1px solid rgba(40, 167, 69, 0.4);
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.2);
        }

        .role-badge.role-keeper:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(40, 167, 69, 0.4);
            border-color: rgba(40, 167, 69, 0.6);
        }


        .btn {
            background: linear-gradient(135deg, 
                #00d4ff 0%, 
                #0099cc 50%, 
                #0066ff 100%);
            color: white;
            border: none;
            padding: 0.875rem 1.75rem;
            border-radius: 16px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 
                0 6px 20px rgba(0, 212, 255, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
            margin: 0;
            position: relative;
            overflow: hidden;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            backdrop-filter: blur(10px);
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, 
                transparent, 
                rgba(255, 255, 255, 0.3), 
                transparent);
            transition: left 0.6s ease;
        }

        .btn:hover::before {
            left: 100%;
        }

        .btn:hover {
            transform: translateY(-4px) scale(1.05);
            box-shadow: 
                0 15px 40px rgba(0, 212, 255, 0.4),
                0 0 30px rgba(0, 212, 255, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
        }

        .btn:active {
            transform: translateY(-2px) scale(1.02);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            background: linear-gradient(135deg, 
                rgba(108, 117, 125, 0.5) 0%, 
                rgba(108, 117, 125, 0.3) 100%);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .btn-success {
            background: linear-gradient(135deg, 
                #28a745 0%, 
                #20c997 50%, 
                #17a2b8 100%);
            box-shadow: 
                0 8px 25px rgba(40, 167, 69, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }

        .btn-success:hover {
            box-shadow: 
                0 15px 40px rgba(40, 167, 69, 0.4),
                0 0 30px rgba(40, 167, 69, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
        }

        /* Documentation Section */
        .documentation-section {
            margin: 3rem 0;
            padding: 2rem 0;
        }

        .doc-header {
            text-align: center;
            margin-bottom: 3rem;
        }

        .doc-header h2 {
            font-size: 2.5rem;
            font-weight: 800;
            background: linear-gradient(135deg, #00d4ff 0%, #0099cc 50%, #0066ff 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 1rem;
            text-shadow: 0 0 30px rgba(0, 212, 255, 0.3);
        }

        .doc-subtitle {
            font-size: 1.2rem;
            color: rgba(232, 232, 232, 0.8);
            font-weight: 500;
            margin: 0;
        }

        .doc-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 2rem;
            margin-bottom: 3rem;
        }

        .doc-card {
            background: linear-gradient(135deg, 
                rgba(255, 255, 255, 0.1) 0%, 
                rgba(255, 255, 255, 0.05) 50%, 
                rgba(0, 0, 0, 0.1) 100%);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 2rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            animation: float 6s ease-in-out infinite;
        }

        .doc-card:nth-child(1) { animation-delay: 0s; }
        .doc-card:nth-child(2) { animation-delay: 1s; }
        .doc-card:nth-child(3) { animation-delay: 2s; }
        .doc-card:nth-child(4) { animation-delay: 3s; }
        .doc-card:nth-child(5) { animation-delay: 4s; }
        .doc-card:nth-child(6) { animation-delay: 5s; }

        .doc-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, 
                #00d4ff 0%, 
                #0099cc 25%, 
                #0066ff 50%, 
                #8b5cf6 75%, 
                #00d4ff 100%);
            background-size: 200% 100%;
            animation: gradientShift 3s ease-in-out infinite;
        }

        .doc-card:hover {
            animation-play-state: paused;
            transform: translateY(-8px);
            box-shadow: 
                0 20px 60px rgba(0, 0, 0, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.2),
                0 0 0 1px rgba(0, 212, 255, 0.3),
                0 0 40px rgba(0, 212, 255, 0.2);
        }

        .doc-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            display: block;
        }

        .doc-card h3 {
            color: #e8e8e8;
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 1rem;
            background: linear-gradient(135deg, #00d4ff 0%, #0099cc 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .doc-card p {
            color: rgba(232, 232, 232, 0.8);
            line-height: 1.6;
            margin-bottom: 1rem;
        }

        .doc-card ul {
            color: rgba(232, 232, 232, 0.8);
            line-height: 1.8;
            padding-left: 1.5rem;
        }

        .doc-card li {
            margin-bottom: 0.5rem;
        }

        .strategy-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .strategy-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .strategy-name {
            font-weight: 600;
            color: #00d4ff;
        }

        .strategy-desc {
            color: rgba(232, 232, 232, 0.7);
            font-size: 0.9rem;
        }

        .fee-structure {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .fee-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .fee-type {
            font-weight: 600;
            color: #e8e8e8;
        }

        .fee-amount {
            color: #00d4ff;
            font-weight: 600;
        }

        .doc-cta {
            text-align: center;
            background: linear-gradient(135deg, 
                rgba(0, 212, 255, 0.1) 0%, 
                rgba(0, 0, 0, 0.2) 100%);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            padding: 3rem 2rem;
            border: 1px solid rgba(0, 212, 255, 0.3);
            box-shadow: 
                0 8px 32px rgba(0, 212, 255, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            animation: float 6s ease-in-out infinite;
            animation-delay: 2.5s;
            transition: all 0.3s ease;
        }

        .doc-cta:hover {
            animation-play-state: paused;
            transform: translateY(-8px);
            box-shadow: 
                0 20px 60px rgba(0, 212, 255, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.2),
                0 0 0 1px rgba(0, 212, 255, 0.4),
                0 0 40px rgba(0, 212, 255, 0.3);
        }

        .doc-cta h3 {
            font-size: 2rem;
            font-weight: 700;
            color: #e8e8e8;
            margin-bottom: 1rem;
            background: linear-gradient(135deg, #00d4ff 0%, #0099cc 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .doc-cta p {
            font-size: 1.1rem;
            color: rgba(232, 232, 232, 0.8);
            margin-bottom: 2rem;
        }

        .cta-features {
            display: flex;
            justify-content: center;
            gap: 2rem;
            flex-wrap: wrap;
        }

        .cta-feature {
            background: rgba(0, 212, 255, 0.2);
            color: #00d4ff;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: 600;
            border: 1px solid rgba(0, 212, 255, 0.3);
        }

        .btn-danger {
            background: var(--danger-gradient);
        }

        .btn-info {
            background: var(--info-gradient);
            color: #2c3e50;
        }

        .btn-warning {
            background: var(--warning-gradient);
            color: #2c3e50;
        }

        .btn-secondary {
            background: var(--dark-gradient);
            color: white;
        }

        .btn:disabled {
            background: rgba(108, 117, 125, 0.3);
            color: rgba(255, 255, 255, 0.5);
            cursor: not-allowed;
            transform: none;
        }

        .btn:disabled:hover {
            transform: none;
            box-shadow: var(--shadow-light);
        }

        .role-badge {
            display: inline-block;
            padding: 0.5rem 1rem;
            border-radius: 25px;
            font-size: 0.9rem;
            font-weight: 600;
            margin-left: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .role-badge.manager {
            background: var(--primary-gradient);
            color: white;
        }

        .role-badge.keeper {
            background: var(--success-gradient);
            color: white;
        }

        .role-badge.user {
            background: var(--info-gradient);
            color: #2c3e50;
        }

        .dashboard {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            margin-bottom: 2rem;
            width: 100%;
            align-items: stretch; /* keep cards full width */
        }
        .dashboard .card {
            width: 100%; /* full screen width within container */
        }
        /* Ensure clear separation between consecutive cards */
        .dashboard .card + .card { margin-top: 2rem; }

        .card {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border-radius: var(--border-radius);
            padding: 1.5rem; /* slightly compact vertical spacing */
            margin-bottom: 3rem; /* ensure clear separation between cards */
            border: 1px solid var(--glass-border);
            box-shadow: var(--shadow-light);
            transition: var(--transition);
            position: relative;
            overflow: hidden;
            animation: float 6s ease-in-out infinite;
        }

        .card:nth-child(1) {
            animation-delay: 0s;
        }

        .card:nth-child(2) {
            animation-delay: 1s;
        }

        .card:nth-child(3) {
            animation-delay: 2s;
        }

        .card:nth-child(4) {
            animation-delay: 3s;
        }

        .card:nth-child(5) {
            animation-delay: 4s;
        }

        .card:nth-child(6) {
            animation-delay: 5s;
        }

        @keyframes float {
            0%, 100% {
                transform: translateY(0px);
                box-shadow: var(--shadow-light);
            }
            50% {
                transform: translateY(-8px);
                box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
            }
        }

        .card:hover {
            animation-play-state: paused;
            transform: translateY(-12px);
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
            border-color: rgba(0, 212, 255, 0.3);
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--primary-gradient);
        }

        .card:hover {
            transform: translateY(-8px);
            box-shadow: var(--shadow-heavy);
        }

        .card h3 {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            color: #e8e8e8;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: #e8e8e8;
            font-weight: 600;
            font-size: 1.1rem;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 1rem;
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: var(--border-radius-small);
            font-size: 1.1rem;
            transition: var(--transition);
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            color: #e8e8e8;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
            background: rgba(255, 255, 255, 0.2);
        }

        .form-group input::placeholder {
            color: rgba(232, 232, 232, 0.5);
        }

        .vault-info {
            background: rgba(255, 255, 255, 0.1);
            border-radius: var(--border-radius-small);
            padding: 1.5rem;
            margin: 1rem 0;
            border-left: 4px solid #667eea;
            backdrop-filter: blur(10px);
        }

        .vault-info h4 {
            font-size: 1.4rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: #e8e8e8;
        }

        .vault-info p {
            margin: 0.5rem 0;
            color: rgba(232, 232, 232, 0.8);
            font-size: 1.1rem;
        }

        .vault-info strong {
            color: #e8e8e8;
            font-weight: 600;
        }

        .status {
            margin-top: 1rem;
            padding: 1rem;
            border-radius: var(--border-radius-small);
            font-weight: 600;
            text-align: center;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .status.success {
            background: rgba(76, 175, 80, 0.1);
            color: #2e7d32;
            border-color: rgba(76, 175, 80, 0.3);
        }

        .status.error {
            background: rgba(244, 67, 54, 0.1);
            color: #c62828;
            border-color: rgba(244, 67, 54, 0.3);
        }

        .status.info {
            background: rgba(33, 150, 243, 0.1);
            color: #1565c0;
            border-color: rgba(33, 150, 243, 0.3);
        }

        .earnings-breakdown {
            background: rgba(255, 193, 7, 0.1);
            border-radius: var(--border-radius-small);
            padding: 1.5rem;
            margin: 1rem 0;
            border-left: 4px solid #ffc107;
            backdrop-filter: blur(10px);
        }

        .earnings-breakdown h5 {
            color: #f57c00;
            margin: 0 0 1rem 0;
            font-size: 1.3rem;
            font-weight: 600;
        }

        .earnings-breakdown p {
            margin: 0.5rem 0;
            color: #f57c00;
            font-weight: 500;
        }

        .vault-stats {
            background: rgba(33, 150, 243, 0.1);
            border-radius: var(--border-radius-small);
            padding: 1.5rem;
            margin: 1rem 0;
            border-left: 4px solid #2196f3;
            backdrop-filter: blur(10px);
        }

        .vault-stats h5 {
            color: #1565c0;
            margin: 0 0 1rem 0;
            font-size: 1.3rem;
            font-weight: 600;
        }

        .vault-stats p {
            margin: 0.5rem 0;
            color: #1565c0;
            font-weight: 500;
        }

        .price-display {
            background: rgba(76, 175, 80, 0.1);
            border-radius: var(--border-radius-small);
            padding: 1.5rem;
            margin: 1rem 0;
            border-left: 4px solid #4caf50;
            backdrop-filter: blur(10px);
            text-align: center;
        }

        .price-display p {
            margin: 0.5rem 0;
            color: #2e7d32;
            font-size: 1.4rem;
            font-weight: 700;
        }

        .pool-info {
            background: rgba(244, 67, 54, 0.1);
            border-radius: var(--border-radius-small);
            padding: 1.5rem;
            margin: 1rem 0;
            border-left: 4px solid #f44336;
            backdrop-filter: blur(10px);
        }

        .pool-info h5 {
            color: #c62828;
            margin: 0 0 1rem 0;
            font-size: 1.3rem;
            font-weight: 600;
        }

        .pool-info p {
            margin: 0.5rem 0;
            color: #c62828;
            font-size: 0.95rem;
            font-weight: 500;
        }

        .contract-address {
            font-family: 'Courier New', monospace;
            background: rgba(0, 0, 0, 0.3);
            padding: 0.75rem 1rem;
            border-radius: 6px;
            word-break: break-all;
            overflow-wrap: anywhere;
            font-size: 0.85rem;
            color: #b3d8ff;
            border: 1px dashed rgba(79,172,254,0.35);
            max-width: 100%;
            display: block;
            margin: 0.5rem 0;
            line-height: 1.4;
            box-sizing: border-box;
        }

        .address-container {
            margin: 0.5rem 0;
        }

        .address-label {
            font-weight: 600;
            color: #e8e8e8;
            margin-bottom: 0.25rem;
            font-size: 0.9rem;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #667eea;
            animation: spin 1s ease-in-out infinite;
        }

        .transaction-processing {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            border-radius: var(--border-radius);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }

        .transaction-processing.active {
            display: flex;
        }

        .processing-spinner {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            border-top-color: #00d4ff;
            border-right-color: #0099cc;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        .processing-text {
            color: #ffffff;
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 10px;
            text-align: center;
        }

        .processing-details {
            color: rgba(255, 255, 255, 0.8);
            font-size: 0.9rem;
            text-align: center;
            max-width: 300px;
        }

        .transaction-steps {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 15px;
            width: 100%;
            max-width: 300px;
        }

        .transaction-step {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .transaction-step.active {
            background: rgba(0, 212, 255, 0.2);
            border: 1px solid #00d4ff;
        }

        .transaction-step.completed {
            background: rgba(40, 167, 69, 0.2);
            border: 1px solid #28a745;
        }

        .step-icon {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }

        .step-icon.pending {
            background: rgba(255, 255, 255, 0.3);
            color: #e8e8e8;
        }

        .step-icon.active {
            background: #00d4ff;
            color: #000;
            animation: pulse 1.5s infinite;
        }

        .step-icon.completed {
            background: #28a745;
            color: #fff;
        }

        .step-text {
            color: #e8e8e8;
            font-size: 0.9rem;
        }

        .step-text.active {
            color: #00d4ff;
            font-weight: 600;
        }

        .step-text.completed {
            color: #28a745;
            font-weight: 600;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .transaction-result {
            margin-top: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: var(--border-radius-small);
            border-left: 4px solid #00d4ff;
            display: none;
        }

        .transaction-result.show {
            display: block;
        }

        .transaction-result.success {
            border-left-color: #28a745;
            background: rgba(40, 167, 69, 0.1);
        }

        .transaction-result.error {
            border-left-color: #dc3545;
            background: rgba(220, 53, 69, 0.1);
        }

        .result-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 10px;
            color: #ffffff;
        }

        .result-details {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 5px;
        }

        .tx-hash {
            font-family: 'JetBrains Mono', 'Fira Code', monospace;
            background: rgba(255, 255, 255, 0.1);
            padding: 5px 10px;
            border-radius: 4px;
            word-break: break-all;
            font-size: 0.8rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .hidden {
            display: none;
        }

        .icon {
            font-size: 1.5rem;
            margin-right: 0.5rem;
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .floating {
            animation: floating 3s ease-in-out infinite;
        }

        @keyframes floating {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        .metric-card {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border-radius: var(--border-radius-small);
            padding: 1.5rem;
            text-align: center;
            border: 1px solid var(--glass-border);
            transition: var(--transition);
        }

        .metric-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-medium);
        }

        .metric-value {
            font-size: 2rem;
            font-weight: 800;
            color: #e8e8e8;
            margin-bottom: 0.5rem;
        }

        .metric-label {
            font-size: 1rem;
            color: rgba(232, 232, 232, 0.7);
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }
            
            .logo-container {
                gap: 0.8rem;
                flex-direction: row;
            }
            .logo-image-container {
                padding: 0.3rem;
            }
            .logo-image {
                height: 40px;
                max-width: 100px;
            }
            .logo-text h1 {
                font-size: 1.8rem;
            }
            .tagline {
                font-size: 0.9rem;
            }
            
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .btn {
                width: 100%;
                margin: 0.5rem 0;
            }
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
        }

        .modal-content {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            margin: 2% auto;
            padding: 0;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
            position: relative;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem 2rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px 20px 0 0;
        }

        .modal-header h3 {
            color: #00f2fe;
            font-size: 1.5rem;
            font-weight: 700;
            margin: 0;
        }

        .close {
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .close:hover {
            color: #00f2fe;
        }

        .how-to-step {
            padding: 1.5rem 2rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .how-to-step:last-child {
            border-bottom: none;
        }

        .how-to-step h4 {
            color: #00f2fe;
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }

        .how-to-step p {
            color: #e8e8e8;
            margin-bottom: 1rem;
            line-height: 1.6;
        }

        .how-to-step ul {
            color: #e8e8e8;
            padding-left: 1.5rem;
            margin-bottom: 1rem;
        }

        .how-to-step li {
            margin-bottom: 0.5rem;
            line-height: 1.5;
        }

        .highlight-box {
            background: rgba(0, 242, 254, 0.1);
            border: 1px solid rgba(0, 242, 254, 0.3);
            border-radius: 12px;
            padding: 1.5rem;
            margin: 1rem 0;
        }

        .highlight-box h4 {
            color: #00f2fe;
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 1rem;
        }

        .highlight-box ul {
            color: #e8e8e8;
            padding-left: 1.5rem;
            margin: 0;
        }

        .highlight-box li {
            margin-bottom: 0.5rem;
            line-height: 1.5;
        }

        .info-note {
            background: rgba(255, 193, 7, 0.1);
            border: 1px solid rgba(255, 193, 7, 0.3);
            border-radius: 8px;
            padding: 12px;
            margin: 10px 0;
        }

        .info-note p {
            margin: 0;
            color: #ffc107;
            font-size: 0.9rem;
        }

        /* Responsive modal */
        @media (max-width: 768px) {
            .modal-content {
                width: 95%;
                margin: 5% auto;
                max-height: 85vh;
            }
            
            .modal-header {
                padding: 1rem 1.5rem;
            }
            
            .how-to-step {
                padding: 1rem 1.5rem;
            }
            
            .modal-header h3 {
                font-size: 1.3rem;
            }
        }

    </style>
    <style>
        /* Small hanging banner below Connect Wallet */
        .network-banner {
            position: absolute;
            top: 42px;
            left: 50%;
            transform: translate(-50%, 0);
            width: max-content;
            padding: 2px 8px;
            border-radius: 6px 8px 8px 6px;
            background: linear-gradient(135deg, rgba(255,255,255,0.10), rgba(255,255,255,0.03));
            border: 1px solid rgba(255,255,255,0.16);
            color: rgba(255,255,255,0.92);
            text-shadow: 0 1px 1px rgba(0,0,0,0.25);
            box-shadow: 0 8px 18px rgba(0,0,0,0.18), inset 0 1px 0 rgba(255,255,255,0.22);
            font-weight: 800;
            font-size: 9px;
            letter-spacing: 0.14em;
            text-transform: uppercase;
            backdrop-filter: blur(8px) saturate(120%);
            z-index: 3;
            pointer-events: none;
            transform-origin: left center;
            animation: flagFloat 5s ease-in-out infinite;
        }
        .network-banner::after {
            /* subtle moving sheen */
            content: '';
            position: absolute;
            top: 0; bottom: 0; left: -20%; width: 40%;
            border-radius: 8px 12px 12px 8px;
            background: linear-gradient(90deg, rgba(255,255,255,0.0), rgba(255,255,255,0.18), rgba(255,255,255,0.0));
            filter: blur(2px);
            animation: sheen 3.5s ease-in-out infinite;
            mix-blend-mode: screen;
        }
        @keyframes sheen {
            0%   { transform: translateX(0); opacity: 0.0; }
            50%  { transform: translateX(220%); opacity: 0.45; }
            100% { transform: translateX(450%); opacity: 0.0; }
        }
        @keyframes flagFloat {
            0%   { transform: translate(-50%, 0) rotate(-0.8deg) skewY(0.6deg); }
            25%  { transform: translate(-50%, -3px) rotate(0.8deg)  skewY(-0.9deg); }
            50%  { transform: translate(-50%, 0) rotate(-0.4deg) skewY(0.4deg); }
            75%  { transform: translate(-50%, -2px) rotate(0.6deg)  skewY(-0.7deg); }
            100% { transform: translate(-50%, 0) rotate(-0.8deg) skewY(0.6deg); }
        }
        .wallet-section .btn.btn-success {
            position: relative;
        }
        /* Swap form layout helpers */
        .form-row { display: flex; gap: 1rem; align-items: flex-end; flex-wrap: nowrap; }
        .form-half { flex: 1 1 0; min-width: 220px; }
        .btn.connected-btn {
            opacity: 0.95;
            cursor: default;
        }
        /* Mobile responsiveness */
        @media (max-width: 768px) {
            .container { padding: 1rem; }
            .header { padding: 1.25rem; }
            .header .logo-text h1 { font-size: 1.6rem; }
            .tagline { font-size: 1rem; margin-top: .25rem; }
            .wallet-section { padding: 1rem; }
            .wallet-info { flex-direction: column; gap: .75rem; align-items: flex-start; }
            .wallet-section .btn { width: 100%; margin-top: .5rem; }
            .network-banner { top: 38px; font-size: 8px; padding: 2px 6px; }
            .documentation-section { padding: 1rem; }
            .doc-grid { display: grid; grid-template-columns: 1fr; gap: 1rem; }
            .doc-card { padding: 1rem; }
            .dashboard { padding: 1rem; }
            .card { padding: 1rem; }
            .form-group input, .form-group select { width: 100%; }
            footer { padding: 1rem !important; }
            
            .contract-address {
                font-size: 0.8rem;
                padding: 0.6rem 0.8rem;
                word-break: break-all;
            }
            
            .wallet-section .wallet-address {
                font-size: 0.8rem;
                padding: 0.6rem 0.8rem;
            }
        }
        @media (max-width: 420px) {
            .header .logo-image { width: 42px; height: 42px; }
            .header .logo-text h1 { font-size: 1.4rem; }
            .tagline { font-size: .95rem; }
        }
        /* Keep swap selectors parallel on most widths; they will wrap only on extremely narrow screens */
    </style>
</head>
<body>
    <div class="container">
        <div class="header floating">
            <div class="logo-container">
                <div class="logo-image-container">
                    <img src="images/ardena-finance-logo.png" alt="Ardena Finance Logo" class="logo-image" />
                </div>
                <div class="logo-text">
                    <h1>Ardena Finance</h1>
                </div>
            </div>
            <p class="tagline">DeFi Vault Management Platform</p>
            <span class="flying-star"></span>
        </div>

        <!-- Wallet Connection Section -->
        <div class="wallet-section">
            <div class="wallet-info" id="walletInfo">
                <div class="wallet-left">
                    <div class="connection-status not-connected" id="connectionStatus">
                        <div class="status-indicator not-connected"></div>
                        <span>Not Connected</span>
                    </div>
                    <div class="wallet-address" id="walletAddress" style="display: none;"></div>
                    <div class="role-badges">
                        <span class="role-badge role-user" id="userRole" style="display: none;">User</span>
                        <span class="role-badge role-manager" id="managerRole" style="display: none;">Manager</span>
                        <span class="role-badge role-keeper" id="keeperRole" style="display: none;">Keeper</span>
                    </div>
                </div>
                <div style="position: relative; display: inline-block;">
                    <button class="btn btn-success" id="connectWallet">Connect Wallet</button>
                    <div class="network-banner">ETHEREUM Sepolia</div>
                </div>
                <a href="https://app.aave.com/faucet/" target="_blank" rel="noopener" class="btn btn-secondary" style="margin-top: 0.5rem; text-decoration: none;"> Mint AAVE Token</a>
                <button class="btn btn-info" onclick="openHowToUseModal()" style="margin-top: 0.5rem;"> How to Use</button>
            </div>
        </div>

        <!-- Project Documentation -->
        <div class="documentation-section">
            <div class="doc-header">
                <h2> Ardena Finance DeFi Vault</h2>
                <p class="doc-subtitle">Professional Yield Farming & Liquidity Management Platform</p>
            </div>
            
            <div class="doc-grid">
                <div class="doc-card">
                    <div class="doc-icon"></div>
                    <h3>What is Ardena Finance?</h3>
                    <p>Ardena Finance is a cutting-edge DeFi vault platform that automatically manages your AAVE investments across multiple yield-generating strategies. Our smart contracts optimize returns while minimizing risk through professional portfolio management.</p>
                </div>
                
                <div class="doc-card">
                    <div class="doc-icon"></div>
                    <h3>How It Works</h3>
                    <p>Deposit AAVE into our vault, and our intelligent system automatically allocates funds across Aave lending pools and Uniswap V3 liquidity positions. Earn compound interest and trading fees while our algorithms rebalance your portfolio for optimal returns.</p>
                </div>
                
                <div class="doc-card">
                    <div class="doc-icon"></div>
                    <h3>Key Features</h3>
                    <ul>
                        <li><strong>Automated Yield Farming:</strong> Earn from multiple DeFi protocols</li>
                        <li><strong>Smart Rebalancing:</strong> AI-driven portfolio optimization</li>
                        <li><strong>Low Fees:</strong> Competitive management and performance fees</li>
                        <li><strong>Transparent:</strong> All transactions on-chain, fully auditable</li>
                        <li><strong>Secure:</strong> Battle-tested smart contracts</li>
                    </ul>
                </div>
                
                <div class="doc-card">
                    <div class="doc-icon"></div>
                    <h3>Investment Strategies</h3>
                    <div class="strategy-list">
                        <div class="strategy-item">
                            <span class="strategy-name">Aave V3 Lending</span>
                            <span class="strategy-desc">Earn interest on AAVE deposits</span>
                        </div>
                        <div class="strategy-item">
                            <span class="strategy-name">Uniswap V3 LP</span>
                            <span class="strategy-desc">Generate fees from AAVE/WETH trading</span>
                        </div>
                    </div>
                </div>
                
                <div class="doc-card">
                    <div class="doc-icon"></div>
                    <h3>Security & Transparency</h3>
                    <p>All smart contracts are deployed on Ethereum Sepolia testnet for testing. Our code is open-source and follows industry best practices. Users maintain full control of their funds with no custodial risks.</p>
                </div>
                
                <div class="doc-card">
                    <div class="doc-icon"></div>
                    <h3>Fee Structure</h3>
                    <div class="fee-structure">
                        <div class="fee-item">
                            <span class="fee-type">Management Fee</span>
                            <span class="fee-amount">2% annually</span>
                        </div>
                        <div class="fee-item">
                            <span class="fee-type">Performance Fee</span>
                            <span class="fee-amount">20% of profits</span>
                        </div>
                        <div class="fee-item">
                            <span class="fee-type">Entry Fee</span>
                            <span class="fee-amount">0.5%</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="doc-cta">
                <h3>Ready to Start Earning?</h3>
                <p>Connect your wallet and start earning yield on your AAVE today!</p>
                <div class="cta-features">
                    <span class="cta-feature"> No minimum deposit</span>
                    <span class="cta-feature"> Instant withdrawals</span>
                    <span class="cta-feature"> Real-time tracking</span>
                </div>
            </div>
        </div>

        <!-- Dashboard -->
        <div class="dashboard">
            <!-- Set Oracle Price -->
            <div class="card" style="position: relative;">
                <h3><span class="icon"></span> Set Oracle Price</h3>
                <div class="flex-row" style="display:flex; gap:1.25rem; align-items:flex-start; flex-wrap:wrap;">
                    <div class="oracle-info" style="flex:1 1 360px; min-width:300px;">
                        <h4>Current Prices</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                            <div style="padding: 0.75rem; background: rgba(0,212,255,0.1); border-radius: 8px; border: 1px solid rgba(0,212,255,0.3);">
                                <div style="font-size: 0.85rem; color: #00d4ff; font-weight: 600;">1 WETH = x AAVE</div>
                                <div id="actualPrice" style="font-size: 1.1rem; color: #e8e8e8; margin-top: 0.25rem;">Loading...</div>
                                <div style="font-size: 0.75rem; color: #888; margin-top: 0.25rem;">From Uniswap V3</div>
                            </div>
                            <div style="padding: 0.75rem; background: rgba(255,165,0,0.1); border-radius: 8px; border: 1px solid rgba(255,165,0,0.3);">
                                <div style="font-size: 0.85rem; color: #ffa500; font-weight: 600;">1 WETH = x AAVE</div>
                                <div id="aggregatorPrice" style="font-size: 1.1rem; color: #e8e8e8; margin-top: 0.25rem;">Loading...</div>
                                <div style="font-size: 0.75rem; color: #888; margin-top: 0.25rem;">From Oracle Calculation</div>
                            </div>
                        </div>
                        
                        <div style="display: flex; gap: 0.75rem; flex-wrap: wrap; justify-content: center;">
                            <button class="btn btn-primary" onclick="setSqrtPrice()" style="flex: 1; min-width: 200px; max-width: 300px;">
                                 Set Oracle Price
                            </button>
                            <button class="btn btn-secondary" onclick="refreshOraclePrices()" style="flex: 1; min-width: 200px; max-width: 300px;">
                                 Refresh Prices
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="transaction-result" id="oracleResult">
                    <div class="result-title">Oracle Update Result</div>
                    <div class="result-details" id="oracleResultDetails"></div>
                </div>
            </div>
            
            <!-- User Actions -->
            <div class="card" style="position: relative;">
                <div class="transaction-processing" id="userActionsProcessing">
                    <div class="processing-spinner"></div>
                    <div class="processing-text">Thanks For Visiting</div>
                    <div class="processing-details">Please wait while your transaction is being processed on the blockchain.</div>
                    
                    <div class="transaction-steps" id="userActionsSteps">
                        <!-- Steps will be dynamically added here -->
                    </div>
                </div>
                
                <h3><span class="icon"></span> User Actions</h3>
                <div class="flex-row" style="display:flex; gap:1.25rem; align-items:flex-start; flex-wrap:wrap;">
                    <div class="vault-info" style="flex:1 1 360px; min-width:300px;">
                        <h4>Vault Information</h4>
                        <p><strong>Name:</strong> <span id="vaultName">AaveUNI6040</span></p>
                        <p><strong>Symbol:</strong> <span id="vaultSymbol">AUNI</span></p>
                        <p><strong>Asset:</strong> <span id="vaultAsset">AAVE</span></p>
                        <p><strong>Total Assets:</strong> <span id="totalAssets">0</span> AAVE</p>
                        <p><strong>Your Shares:</strong> <span id="userShares">0</span></p>
                        <p><strong>Your Assets:</strong> <span id="userAssets">0</span> AAVE</p>
                    </div>
                    <div class="actions-col" style="flex:1 1 360px; min-width:300px;">
                        <div class="form-group">
                            <label for="depositAmount">Deposit Amount (AAVE)</label>
                            <input type="number" id="depositAmount" placeholder="Enter amount to deposit" step="0.000001">
                        </div>
                        <button class="btn" id="depositBtn" onclick="deposit()">Deposit</button>
                        <div class="form-group" style="margin-top:1rem;">
                            <label for="withdrawAmount">Withdraw Amount (Shares)</label>
                            <input type="number" id="withdrawAmount" placeholder="Enter shares to withdraw" step="0.000001" oninput="updateSharesToAssetsConversion()">
                            <div id="sharesToAssetsConversion" style="margin-top: 0.5rem; padding: 0.5rem; background: rgba(0,212,255,0.1); border-radius: 6px; border-left: 3px solid #00d4ff; display: none;">
                                <div style="font-size: 0.85rem; color: #00d4ff; font-weight: 600;">Estimated AAVE to receive:</div>
                                <div id="convertedAssets" style="font-size: 1rem; color: #e8e8e8; margin-top: 0.25rem;">0.000000 AAVE</div>
                            </div>
                        </div>
                        <button class="btn btn-secondary" id="withdrawBtn" onclick="withdraw()">Withdraw</button>
                    </div>
                </div>
                
                <div class="transaction-result" id="userActionsResult">
                    <div class="result-title">Transaction Result</div>
                    <div class="result-details" id="userActionsResultDetails"></div>
                </div>
            </div>

            <!-- Manager Actions -->
            <div class="card" style="position: relative;">
                <div class="transaction-processing" id="managerActionsProcessing">
                    <div class="processing-spinner"></div>
                    <div class="processing-text">Thanks For Visiting</div>
                    <div class="processing-details">Please wait while your transaction is being processed on the blockchain.</div>
                    
                    <div class="transaction-steps" id="managerActionsSteps">
                        <!-- Steps will be dynamically added here -->
                    </div>
                </div>
                
                <h3><span class="icon"></span> Manager & Keeper Actions</h3>
                <div class="manager-actions-grid">
                    
                    <!-- Section 1: Invest Idle Funds -->
                    <div class="manager-section">
                        <h4> Invest Idle Funds</h4>
                        <div class="section-content">
                            <p><strong>Idle Funds:</strong> <span id="idleFunds">0</span> AAVE</p>
                            <div id="strategyAllocations">
                                <p><em>Loading strategy allocations...</em></p>
                            </div>
                            <button class="btn btn-success" id="investIdleBtn" onclick="investIdle()">Invest Idle Funds</button>
                            <div id="investIdleStatus"></div>
                        </div>
                    </div>

                    <!-- Section 2: Rebalance Strategies -->
                    <div class="manager-section">
                        <h4> Rebalance Strategies</h4>
                        <div class="section-content">
                            <div id="strategyPercentages">
                                <p><em>Loading strategy percentages...</em></p>
                            </div>
                            <button class="btn btn-primary" id="rebalanceBtn" onclick="rebalanceStrategies()">Rebalance</button>
                            <div id="rebalanceStatus"></div>
                        </div>
                    </div>

                    <!-- Section 3: Harvest All Strategies -->
                    <div class="manager-section">
                        <h4> Harvest All Strategies</h4>
                        <div class="section-content">
                            <p><strong>Last Harvest:</strong> <span id="lastHarvest">Never</span></p>
                            <p><strong>Min Harvest Interval:</strong> <span id="minHarvestInterval">3600</span> seconds</p>
                            <p><strong>Can Harvest:</strong> <span id="canHarvest">Yes</span></p>
                            <button class="btn btn-warning" id="harvestBtn" onclick="harvestAll()">Harvest All Strategies</button>
                            <div id="harvestStatus"></div>
                        </div>
                    </div>

                </div>
                
                <div class="transaction-result" id="managerActionsResult">
                    <div class="result-title">Transaction Result</div>
                    <div class="result-details" id="managerActionsResultDetails"></div>
                </div>
            </div>

        <!-- Token Price Display -->
        <div class="card">
            <h3><span class="icon"></span> Token Prices</h3>
                <div class="flex-row" style="display:flex; gap:1.25rem; align-items:flex-start; flex-wrap:wrap;">
                    <div class="vault-info" style="flex:1 1 360px; min-width:300px;">
                        <h4>Current Exchange Rates</h4>
                        <div class="price-display">
                            <p><strong>1 WETH =</strong> <span id="wethToAavePrice">-</span> <strong>AAVE</strong></p>
                            <p><strong>1 AAVE =</strong> <span id="aaveToWethPrice">-</span> <strong>WETH</strong></p>
                        </div>
                    </div>
                    <div class="vault-info" style="flex:1 1 360px; min-width:300px;">
                        <h4>Pool Information</h4>
                        <div class="address-container">
                            <div class="address-label">Pool Address:</div>
                            <div class="contract-address" id="poolAddress">-</div>
                        </div>
                        <p><strong>Tokens:</strong> <span id="tokenPair">-</span></p>
                        <p><strong>Pool Fee:</strong> <span id="poolFee">-</span>%</p>
                        <button class="btn btn-info" style="margin-top:1rem;" onclick="refreshTokenPrice()"> Refresh Price</button>
                    </div>
                </div>
            </div>

        <!-- User Fee Earnings -->
        <div class="card">
            <h3><span class="icon"></span> Your Fee Earnings</h3>
                <div class="flex-row" style="display:flex; gap:1.25rem; align-items:flex-start; flex-wrap:wrap;">
                    <div class="vault-info" style="flex:1 1 360px; min-width:300px;">
                        <h4>Estimated Earnings Breakdown</h4>
                        <p><strong>Your Vault Share:</strong> <span id="userSharePercentage">-</span>%</p>
                        <p><strong>Total Estimated Earnings:</strong> <span id="totalFeeEarnings">-</span> AAVE</p>
                        <div class="earnings-breakdown">
                            <h5>Earnings Sources:</h5>
                            <p><strong>Trading Fees (AAVE):</strong> <span id="tradingFeesAAVE">-</span> AAVE</p>
                            <p><strong>Trading Fees (WETH):</strong> <span id="tradingFeesWETH">-</span> WETH</p>
                            <p><strong>Management Fees:</strong> <span id="managementFees">-</span> AAVE</p>
                            <p><strong>Performance Fees:</strong> <span id="performanceFees">-</span> AAVE</p>
                        </div>
                    </div>
                    <div class="vault-info" style="flex:1 1 360px; min-width:300px;">
                        <h4>Vault Statistics</h4>
                        <p><strong>Your Shares:</strong> <span id="userSharesDisplay">-</span> AAVE</p>
                        <p><strong>Total Vault Assets:</strong> <span id="totalVaultAssets">-</span> AAVE</p>
                        <button class="btn btn-info" style="margin-top:1rem;" onclick="refreshFeeEarnings()"> Refresh Earnings</button>
                    </div>
                </div>
            </div>

        <!-- Swap Section -->
        <div class="card" style="position: relative;">
            <div class="transaction-processing" id="swapProcessing">
                <div class="processing-spinner"></div>
                <div class="processing-text">Thanks For Visiting</div>
                <div class="processing-details">Please wait while your transaction is being processed on the blockchain.</div>
                
                <div class="transaction-steps" id="swapSteps">
                    <!-- Steps will be dynamically added here -->
                </div>
            </div>
            
            <h3><span class="icon"></span> Token Swap</h3>
                <div class="flex-row" style="display:flex; gap:1.25rem; align-items:flex-start; flex-wrap:wrap;">
                <div class="vault-info" style="flex:1 1 360px; min-width:300px;">
                    <h4>Direct Token Swapping</h4>
                    <p><strong>Swap between WETH and AAVE</strong></p>
                    
                    <div class="address-container">
                        <div class="address-label">Router Address:</div>
                        <div class="contract-address">0x3bFA4769FB09eefC5a80d6E87c3B9C650f7Ae48E</div>
                    </div>
                    
                    <div class="address-container">
                        <div class="address-label">Pool Address:</div>
                        <div class="contract-address">0x0E98753e483679703c902a0f574646d3653ad9eA</div>
                    </div>
                </div>
                <div class="actions-col" style="flex:1 1 360px; min-width:300px;">
                <div class="form-row">
                    <div class="form-group form-half">
                        <label for="swapFromToken">From Token</label>
                        <select id="swapFromToken">
                            <option value="AAVE">AAVE</option>
                            <option value="WETH">WETH</option>
                        </select>
                    </div>
                    <div class="form-group form-half">
                        <label for="swapToToken">To Token</label>
                        <select id="swapToToken">
                            <option value="WETH">WETH</option>
                            <option value="AAVE">AAVE</option>
                        </select>
                    </div>
                </div>

                <div class="form-group" style="margin-top:1rem;">
                    <label for="swapAmount">Amount to Swap</label>
                    <input type="number" id="swapAmount" placeholder="Enter amount" step="0.000001">
                    <div id="swapEstimate" style="margin-top:.5rem;color:rgba(232,232,232,.9);font-size:.95rem;min-height:1.2rem"></div>
                </div>

                <button class="btn btn-success" id="swapBtn" onclick="performSwap()">Execute Swap</button>
                <div id="swapStatus"></div>
                
                <div class="transaction-result" id="swapResult">
                    <div class="result-title"></div>
                    <div class="result-details" id="swapResultDetails"></div>
                    <div class="tx-hash" id="swapTxHash"></div>
                </div>
                </div>
                </div>
            </div>


        <!-- Status Messages -->
        <div id="statusMessages"></div>

        <!-- Loading Indicator -->
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Thanks For Visiting</p>
        </div>

        <!-- Creative Footer -->
        <footer style="margin-top:2.5rem;padding:1.25rem;border-radius:14px;background:linear-gradient(135deg,rgba(255,255,255,.06),rgba(255,255,255,.03));border:1px solid rgba(255,255,255,.12);box-shadow:0 18px 40px rgba(0,0,0,.22);backdrop-filter:blur(10px)">
            <div style="display:flex;flex-wrap:wrap;align-items:center;gap:1rem;justify-content:space-between;">
                <div style="display:flex;align-items:center;gap:.6rem;">
                    <img src="images/ardena-finance-logo.png" alt="Ardena Finance" style="width:36px;height:36px;border-radius:10px;object-fit:cover;box-shadow:0 10px 24px rgba(0,0,0,.25)" />
                    <div>
                        <div style="font-weight:900;letter-spacing:.08em;color:#eaf3ff;">Ardena Finance</div>
                        <div style="font-size:12px;color:rgba(232,232,232,.7)">Secure Yield On Ethereum Sepolia</div>
                    </div>
                </div>

                <div style="display:flex;gap:1rem;flex-wrap:wrap;">
                    <a href="/whitepaper" class="btn btn-secondary" style="text-decoration:none;"> Whitepaper</a>
                    <a href="https://app.aave.com/faucet/" target="_blank" rel="noopener" class="btn btn-secondary" style="text-decoration:none;"> Mint AAVE Token</a>
                </div>
            </div>
            <div style="margin-top:.75rem;display:flex;gap:1rem;flex-wrap:wrap;color:rgba(232,232,232,.75);font-size:12px;">
                <span> <script>document.write(new Date().getFullYear())</script> Ardena Finance</span>
                <span></span>
                <span>Built for Sepolia Testnet</span>
                <span></span>
                <span>v1.0</span>
            </div>
        </footer>
    </div>

    <!-- Include Ethers.js v6 -->
    <script src="https://cdn.jsdelivr.net/npm/ethers@6.15.0/dist/ethers.umd.min.js"></script>
    <script>
        // Fallback if first CDN fails
        if (typeof ethers === 'undefined') {
            console.log('Loading Ethers.js from fallback CDN...');
            const script = document.createElement('script');
            script.src = 'https://cdn.ethers.io/lib/ethers-6.15.0.umd.min.js';
            document.head.appendChild(script);
        }
    </script>
    <!-- Include Configuration -->
    <script src="config.js?v=71&t=1738683000"></script>
    <!-- Include Integration Module -->
    <script src="integration.js?v=82&t=1738691000"></script>
    
    <script>
        // Global integration instance
        let vaultIntegration = null;
        let userAddress = null;
        let userRole = 'user';

        // Initialize when page loads
        window.addEventListener('load', async () => {
            // Wait a bit for scripts to load
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // Check if Ethers.js is loaded
            if (typeof ethers === 'undefined') {
                showStatus('Ethers.js library not loaded. Please refresh the page.', 'error');
                console.error('Ethers.js not found');
                return;
            }
            
            console.log('Ethers.js loaded successfully:', typeof ethers);
            
            // Check if VaultIntegration class is loaded
            if (typeof VaultIntegration === 'undefined') {
                showStatus('VaultIntegration class not loaded. Please refresh the page.', 'error');
                console.error('VaultIntegration class not found');
                console.log('Available on window:', Object.keys(window).filter(k => k.includes('Vault')));
                return;
            }
            
            console.log('VaultIntegration class loaded successfully:', typeof VaultIntegration);
            
            if (typeof window.ethereum !== 'undefined') {
                // Don't load vault info yet - wait for wallet connection
                
                // Listen for network changes
                window.ethereum.on('chainChanged', (chainId) => {
                    console.log('Network changed to:', chainId);
                    if (chainId === '0xaa36a7') {
                        showStatus('Switched to Sepolia testnet!', 'success');
                    } else {
                        showStatus('Please switch to Sepolia testnet', 'error');
                    }
                });
                
                // Listen for account changes
                window.ethereum.on('accountsChanged', (accounts) => {
                    console.log('Account changed:', accounts);
                    if (accounts.length > 0) {
                        userAddress = accounts[0];
                        document.getElementById('walletAddress').textContent = userAddress;
                        showStatus('Account changed', 'info');
                    } else {
                        // User disconnected
                        userAddress = null;
                        document.getElementById('walletAddress').textContent = 'Not Connected';
                        document.getElementById('connectWallet').textContent = 'Connect Wallet';
                        document.getElementById('connectWallet').disabled = false;
                        showStatus('Wallet disconnected', 'info');
                    }
                });
            } else {
                showStatus('Please install MetaMask to use this application', 'error');
            }
        });

        // Connect wallet
        document.getElementById('connectWallet').addEventListener('click', connectWallet);

        async function connectWallet() {
            try {
                if (typeof window.ethereum === 'undefined') {
                    showStatus('Please install MetaMask', 'error');
                    return;
                }

                showStatus('Connecting wallet...', 'info');

                // Request account access
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                userAddress = accounts[0];
                
                console.log('Connected to wallet:', userAddress);

                // Check network and request switch to Sepolia if needed
                const chainId = await window.ethereum.request({ method: 'eth_chainId' });
                console.log('Current chain ID:', chainId);
                if (chainId !== '0xaa36a7') {
                    try {
                        // Try to switch to Sepolia
                        await window.ethereum.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: '0xaa36a7' }], // 11155111
                        });
                        showStatus('Requesting network change to Sepolia', 'info');
                    } catch (switchError) {
                        // If the chain is not added to MetaMask, add it
                        if (switchError.code === 4902 || (switchError?.message || '').includes('Unrecognized chain ID')) {
                            try {
                                await window.ethereum.request({
                                    method: 'wallet_addEthereumChain',
                                    params: [{
                                        chainId: '0xaa36a7',
                                        chainName: 'Sepolia',
                                        nativeCurrency: { name: 'Sepolia ETH', symbol: 'ETH', decimals: 18 },
                                        rpcUrls: ['https://sepolia.infura.io/v3/'],
                                        blockExplorerUrls: ['https://sepolia.etherscan.io/']
                                    }]
                                });
                                showStatus('Sepolia added to MetaMask. Switching', 'success');
                            } catch (addErr) {
                                console.warn('Failed to add Sepolia network', addErr);
                                showStatus('Please switch to Sepolia in MetaMask', 'error');
                            }
                        } else {
                            console.warn('User rejected or failed to switch network', switchError);
                            showStatus('Please switch to Sepolia in MetaMask', 'error');
                        }
                    }
                }

                // Check if VaultIntegration instance is available
                if (!window.vaultIntegration) {
                    showStatus('VaultIntegration not initialized. Please refresh the page.', 'error');
                    console.error('VaultIntegration instance not found in connectWallet');
                    return;
                }
                
                // Connect wallet to existing VaultIntegration instance
                console.log('Connecting wallet to existing VaultIntegration instance...');
                window.vaultIntegration.provider = new ethers.BrowserProvider(window.ethereum);
                window.vaultIntegration.signer = await window.vaultIntegration.provider.getSigner();
                window.vaultIntegration.userAddress = userAddress;
                
                // Initialize wallet-specific functionality
                await window.vaultIntegration.initializeWithWallet();
                userRole = window.vaultIntegration.userRole;
                
                // Update global reference
                vaultIntegration = window.vaultIntegration;

                console.log('Integration initialized, user role:', userRole);

                // Refresh vault information to show user-specific data
                console.log('Refreshing vault information with user data...');
                await loadVaultInfo();
                await refreshStrategyPercentages();

                // Update connection status
                const connectionStatus = document.getElementById('connectionStatus');
                const statusIndicator = connectionStatus.querySelector('.status-indicator');
                const statusText = connectionStatus.querySelector('span');
                
                connectionStatus.className = 'connection-status connected';
                statusIndicator.className = 'status-indicator connected';
                statusText.textContent = 'Connected';
                
                // Update wallet address with modern styling
                const walletAddress = document.getElementById('walletAddress');
                walletAddress.textContent = 
                    userAddress.substring(0, 6) + '...' + userAddress.substring(userAddress.length - 4);
                walletAddress.style.display = 'block';
                
                // Add connected class to wallet info
                document.getElementById('walletInfo').classList.add('connected');
                
                const connectBtn = document.getElementById('connectWallet');
                connectBtn.textContent = 'Connected';
                connectBtn.classList.add('connected-btn');
                connectBtn.disabled = true;
                document.getElementById('connectWallet').disabled = true;
                document.getElementById('refreshData').disabled = false;
                
                console.log('UI updated - wallet address:', userAddress);
                console.log('UI updated - button text:', document.getElementById('connectWallet').textContent);

                // Update role badges
                updateRoleBadges();

                // Show loading state immediately
                showStatus('Loading vault data...', 'info');
                
                // Load vault info immediately (no delay)
                await loadVaultInfo();
                
                // Refresh token prices and fee earnings after wallet connection
                if (typeof refreshTokenPrice === 'function') {
                    try {
                        await refreshTokenPrice();
                    } catch (error) {
                        console.error('Failed to refresh token prices after wallet connection:', error);
                    }
                }
                
                if (typeof refreshFeeEarnings === 'function') {
                    try {
                        await refreshFeeEarnings();
                    } catch (error) {
                        console.error('Failed to refresh fee earnings after wallet connection:', error);
                    }
                }
                
                showStatus('Wallet connected successfully!', 'success');
            } catch (error) {
                console.error('Wallet connection error:', error);
                showStatus('Failed to connect wallet: ' + error.message, 'error');
            }
        }

        function updateRoleBadges() {
            // Safely hide all role badges first
            const userRoleEl = document.getElementById('userRole');
            const managerRoleEl = document.getElementById('managerRole');
            const keeperRoleEl = document.getElementById('keeperRole');
            
            if (userRoleEl) userRoleEl.style.display = 'none';
            if (managerRoleEl) managerRoleEl.style.display = 'none';
            if (keeperRoleEl) keeperRoleEl.style.display = 'none';

            // Show appropriate role badge
            if (userRole === 'manager' && managerRoleEl) {
                managerRoleEl.style.display = 'inline-block';
            } else if (userRole === 'keeper' && keeperRoleEl) {
                keeperRoleEl.style.display = 'inline-block';
            } else if (userRoleEl) {
                userRoleEl.style.display = 'inline-block';
            }
        }

        async function loadVaultInfo() {
            const vi = window.vaultIntegration;
            if (!vi) {
                console.log('VaultIntegration not initialized, skipping vault info load');
                return;
            }

            // Check if contracts are initialized
            if (!vi.contracts || !vi.contracts.vault) {
                console.log('Contracts not initialized, skipping vault info load');
                return;
            }

            try {
                console.log('Loading vault info at:', new Date().toISOString());
                
                // Show loading states immediately
                showLoadingStates();
                
                // Load all data in parallel for faster loading
                const [vaultInfo, strategyInfo, feeInfo, feeEarnings, tokenPrice] = await Promise.all([
                    vi.getVaultInfo(),
                    vi.getStrategyInfo(),
                    vi.getFeeInfo(),
                    vi.getUserFeeEarnings(),
                    vi.getTokenPrice()
                ]);

                console.log('Vault info loaded:', vaultInfo);
                console.log('Strategy info loaded:', strategyInfo);
                console.log('=== DEBUGGING VAULT DATA ===');
                console.log('totalAssets from vaultInfo:', vaultInfo.totalAssets);
                console.log('idleFunds from strategyInfo:', strategyInfo.idleFunds);
                console.log('userShares from vaultInfo:', vaultInfo.userShares);
                console.log('userAssets from vaultInfo:', vaultInfo.userAssets);

                // Update vault basic info
                if (vaultInfo && vaultInfo.name) {
                    document.getElementById('vaultName').textContent = vaultInfo.name;
                    document.getElementById('vaultSymbol').textContent = vaultInfo.symbol;
                    document.getElementById('totalAssets').textContent = vaultInfo.totalAssets;
                    document.getElementById('userShares').textContent = vaultInfo.userShares;
                    document.getElementById('userAssets').textContent = vaultInfo.userAssets;

                    // Update harvest info
                    document.getElementById('lastHarvest').textContent = vaultInfo.lastHarvest;
                    document.getElementById('minHarvestInterval').textContent = vaultInfo.minHarvestInterval;
                    document.getElementById('canHarvest').textContent = vaultInfo.canHarvest ? 'Yes' : 'No';
                }

                // Update strategy info
                if (strategyInfo) {
                    document.getElementById('idleFunds').textContent = strategyInfo.idleFunds;
                    
                    // Update strategy allocations
                    const aaveStrategy = strategyInfo.strategies.find(s => s.name === 'Aave V3');
                    const uniStrategy = strategyInfo.strategies.find(s => s.name === 'Uniswap V3');
                    
                    document.getElementById('aaveAllocation').textContent = aaveStrategy ? aaveStrategy.allocation + '%' : '0%';
                    document.getElementById('uniAllocation').textContent = uniStrategy ? uniStrategy.allocation + '%' : '0%';
                }

                // Update token prices
                if (tokenPrice) {
                    document.getElementById('wethToAavePrice').textContent = tokenPrice.wethToAave;
                    document.getElementById('aaveToWethPrice').textContent = tokenPrice.aaveToWeth;
                    document.getElementById('poolAddress').textContent = tokenPrice.poolAddress;
                    document.getElementById('tokenPair').textContent = `${tokenPrice.token0Symbol}/${tokenPrice.token1Symbol}`;
                    document.getElementById('poolFee').textContent = (parseFloat(tokenPrice.poolFee) / 10000).toFixed(2);
                }

                // Update fee earnings
                if (feeEarnings) {
                    document.getElementById('userSharePercentage').textContent = feeEarnings.userSharePercentage.toFixed(4);
                    document.getElementById('totalFeeEarnings').textContent = parseFloat(feeEarnings.estimatedFeeEarnings).toFixed(6);
                    document.getElementById('tradingFeesAAVE').textContent = parseFloat(feeEarnings.estimatedTradingFeesAAVE).toFixed(6);
                    document.getElementById('tradingFeesWETH').textContent = parseFloat(feeEarnings.estimatedTradingFeesWETH).toFixed(8);
                    document.getElementById('managementFees').textContent = parseFloat(feeEarnings.estimatedManagementFees).toFixed(6);
                    document.getElementById('performanceFees').textContent = parseFloat(feeEarnings.estimatedPerformanceFees).toFixed(6);
                    document.getElementById('userSharesDisplay').textContent = parseFloat(feeEarnings.userShares).toFixed(6);
                    document.getElementById('totalVaultAssets').textContent = parseFloat(feeEarnings.totalAssets).toFixed(6);
                }

                console.log('Vault info updated successfully');
                
                // Hide loading states
                hideLoadingStates();

            } catch (error) {
                console.error('Error loading vault info:', error);
                showStatus('Error loading vault information: ' + error.message, 'error');
                hideLoadingStates();
            }
        }

        // Show loading states for all data fields
        function showLoadingStates() {
            const loadingElements = [
                'vaultName', 'vaultSymbol', 'totalAssets', 'userShares', 'userAssets',
                'idleFunds', 'aaveAllocation', 'uniAllocation', 'wethToAavePrice', 
                'aaveToWethPrice', 'poolAddress', 'tokenPair', 'poolFee',
                'userSharePercentage', 'totalFeeEarnings', 'tradingFeesAAVE', 
                'tradingFeesWETH', 'managementFees', 'performanceFees'
            ];
            
            loadingElements.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = 'Loading...';
                    element.style.opacity = '0.6';
                }
            });
        }

        // Hide loading states and restore normal appearance
        function hideLoadingStates() {
            const loadingElements = [
                'vaultName', 'vaultSymbol', 'totalAssets', 'userShares', 'userAssets',
                'idleFunds', 'aaveAllocation', 'uniAllocation', 'wethToAavePrice', 
                'aaveToWethPrice', 'poolAddress', 'tokenPair', 'poolFee',
                'userSharePercentage', 'totalFeeEarnings', 'tradingFeesAAVE', 
                'tradingFeesWETH', 'managementFees', 'performanceFees'
            ];
            
            loadingElements.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.style.opacity = '1';
                }
            });
        }

        async function refreshFeeEarnings() {
            console.log('=== REFRESH FEE EARNINGS CALLED ===');
            console.log('vaultIntegration exists:', !!vaultIntegration);
            
            if (!vaultIntegration) {
                console.log('Creating VaultIntegration instance for fee earnings...');
                vaultIntegration = new VaultIntegration();
                // Try to initialize in read-only mode first
                try {
                    await vaultIntegration.initializeReadOnly();
                } catch (error) {
                    console.log('Read-only initialization failed, will try with wallet connection:', error);
                }
            }

            try {
                showStatus('Refreshing fee earnings...', 'info');
                console.log('Calling vaultIntegration.getUserFeeEarnings()...');
                const feeEarnings = await vaultIntegration.getUserFeeEarnings();
                console.log('Fee earnings result:', feeEarnings);
                
                if (feeEarnings) {
                    console.log('Updating UI with fee earnings data...');
                    document.getElementById('userSharePercentage').textContent = feeEarnings.userSharePercentage.toFixed(4);
                    document.getElementById('totalFeeEarnings').textContent = parseFloat(feeEarnings.estimatedFeeEarnings).toFixed(6);
                    document.getElementById('tradingFeesAAVE').textContent = parseFloat(feeEarnings.estimatedTradingFeesAAVE).toFixed(6);
                    document.getElementById('tradingFeesWETH').textContent = parseFloat(feeEarnings.estimatedTradingFeesWETH).toFixed(8);
                    document.getElementById('managementFees').textContent = parseFloat(feeEarnings.estimatedManagementFees).toFixed(6);
                    document.getElementById('performanceFees').textContent = parseFloat(feeEarnings.estimatedPerformanceFees).toFixed(6);
                    document.getElementById('userSharesDisplay').textContent = parseFloat(feeEarnings.userShares).toFixed(6);
                    document.getElementById('totalVaultAssets').textContent = parseFloat(feeEarnings.totalAssets).toFixed(6);
                    
                    showStatus('Fee earnings refreshed successfully!', 'success');
                } else {
                    console.log('Fee earnings result is null/undefined');
                    showStatus('Failed to get fee earnings data', 'error');
                }
            } catch (error) {
                console.error('Error refreshing fee earnings:', error);
                showStatus('Error refreshing fee earnings: ' + error.message, 'error');
            }
        }

        async function refreshTokenPrice() {
            console.log('=== REFRESH TOKEN PRICE CALLED ===');
            console.log('vaultIntegration exists:', !!vaultIntegration);
            
            if (!vaultIntegration) {
                console.log('Creating VaultIntegration instance...');
                vaultIntegration = new VaultIntegration();
                // Try to initialize in read-only mode first
                try {
                    await vaultIntegration.initializeReadOnly();
                } catch (error) {
                    console.log('Read-only initialization failed, will try with wallet connection:', error);
                }
            }

            try {
                showStatus('Refreshing token prices...', 'info');
                console.log('Calling vaultIntegration.getTokenPrice()...');
                const tokenPrice = await vaultIntegration.getTokenPrice();
                console.log('Token price result:', tokenPrice);
                
                if (tokenPrice) {
                    console.log('Updating UI with token price data...');
                    document.getElementById('wethToAavePrice').textContent = tokenPrice.wethToAave;
                    document.getElementById('aaveToWethPrice').textContent = tokenPrice.aaveToWeth;
                    document.getElementById('poolAddress').textContent = tokenPrice.poolAddress;
                    document.getElementById('tokenPair').textContent = `${tokenPrice.token0Symbol}/${tokenPrice.token1Symbol}`;
                    document.getElementById('poolFee').textContent = (parseFloat(tokenPrice.poolFee) / 10000).toFixed(2);
                    
                    showStatus('Token prices refreshed successfully!', 'success');
                } else {
                    console.log('Token price result is null/undefined');
                    showStatus('Failed to get token price data', 'error');
                }
            } catch (error) {
                console.error('Error refreshing token prices:', error);
                showStatus('Error refreshing token prices: ' + error.message, 'error');
            }
        }

        async function deposit() {
            if (typeof ethers === 'undefined') {
                showStatus('Ethers.js library not loaded. Please refresh the page.', 'error');
                return;
            }
            
            if (!vaultIntegration || !vaultIntegration.contracts || !vaultIntegration.contracts.vault || !vaultIntegration.contracts.asset) {
                showStatus('Please connect your wallet first', 'error');
                return;
            }

            const amount = document.getElementById('depositAmount').value;
            if (!amount || amount <= 0) {
                showStatus('Please enter a valid deposit amount', 'error');
                return;
            }

            try {
                // Debug: Check if vaultIntegration is properly initialized
                console.log('=== DEPOSIT DEBUG ===');
                console.log('VaultIntegration exists:', !!vaultIntegration);
                console.log('VaultIntegration contracts:', !!vaultIntegration?.contracts);
                console.log('VaultIntegration contracts.vault:', !!vaultIntegration?.contracts?.vault);
                console.log('User address:', vaultIntegration?.userAddress);
                console.log('Amount to deposit:', amount);
                
                // Check user's USDC balance before deposit
                if (vaultIntegration?.contracts?.usdc) {
                    const userBalance = await vaultIntegration.contracts.usdc.balanceOf(vaultIntegration.userAddress);
                    console.log('User USDC balance:', ethers.formatUnits(userBalance, 6), 'USDC');
                    
                    if (userBalance < ethers.parseUnits(amount, 6)) {
                        throw new Error(`Insufficient USDC balance. You have ${ethers.formatUnits(userBalance, 6)} USDC, trying to deposit ${amount} USDC`);
                    }
                }
                
                // Show processing overlay for User Actions card
                console.log('About to show transaction processing...');
                console.log('DOM ready state:', document.readyState);
                console.log('Processing element exists:', !!document.getElementById('userActionsProcessing'));
                showTransactionProcessing('userActionsProcessing', true);
                hideTransactionResult('userActionsResult');
                
                // Create transaction steps
                const steps = ['Checking allowance...', 'Approving USDC...', 'Depositing to vault...', 'Deposit complete'];
                createTransactionSteps('userActionsSteps', steps);
                
                // Step 1: Check allowance
                updateTransactionText('userActionsProcessing', 'Preparing deposit...', 'Checking USDC allowance');
                updateTransactionStep('userActionsSteps', 0, 'active');
                
                // Small delay to show the step
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // Step 2: Approve if needed
                updateTransactionText('userActionsProcessing', 'Approving USDC...', 'Setting USDC allowance for vault');
                updateTransactionStep('userActionsSteps', 0, 'completed');
                updateTransactionStep('userActionsSteps', 1, 'active');
                
                // Small delay to show the approving step
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Step 3: Depositing (this will wait for MetaMask confirmation)
                updateTransactionText('userActionsProcessing', 'Depositing to vault...', 'Deposit transaction in progress');
                updateTransactionStep('userActionsSteps', 1, 'completed');
                updateTransactionStep('userActionsSteps', 2, 'active');
                
                console.log('Attempting deposit of:', amount, 'USDC');
                
                // Add more detailed error handling
                let result;
                try {
                    result = await vaultIntegration.deposit(amount);
                    console.log('Deposit result:', result);
                } catch (depositError) {
                    console.error('Deposit failed with error:', depositError);
                    throw depositError; // Re-throw to be caught by outer try-catch
                }
                
                // Step 4: Complete
                updateTransactionText('userActionsProcessing', 'Deposit completed!', 'Successfully deposited to vault');
                updateTransactionStep('userActionsSteps', 2, 'completed');
                updateTransactionStep('userActionsSteps', 3, 'completed');

                // Show success result
                showTransactionResult('userActionsResult', 'success', 
                    `Successfully deposited ${amount} USDC!`, 
                    `Transaction Hash: ${result.txHash}`);
                
                // Make transaction hash clickable for copying
                setTimeout(() => {
                    makeTransactionHashClickable('userActionsResultDetails', result.txHash);
                }, 100);
                
                document.getElementById('depositAmount').value = '';
                await loadVaultInfo();
                
                // Hide processing after a delay
                setTimeout(() => {
                    showTransactionProcessing('userActionsProcessing', false);
                }, 2000);

            } catch (error) {
                console.error('=== DEPOSIT ERROR ===');
                console.error('Error type:', typeof error);
                console.error('Error message:', error.message);
                console.error('Error stack:', error.stack);
                console.error('Full error object:', error);
                
                // Show error result
                showTransactionResult('userActionsResult', 'error', 
                    'Deposit Failed', 
                    `Error: ${error.message}`);
                
                // Hide processing overlay
                showTransactionProcessing('userActionsProcessing', false);
            }
        }

        async function withdraw() {
            if (!vaultIntegration) {
                showStatus('Please connect your wallet first', 'error');
                return;
            }

            const shares = document.getElementById('withdrawAmount').value;
            if (!shares || shares <= 0) {
                showStatus('Please enter a valid withdrawal amount', 'error');
                return;
            }

            try {
                showLoading(true);

                // Show processing overlay and steps (reuse User Actions widgets)
                showTransactionProcessing('userActionsProcessing', true);
                hideTransactionResult('userActionsResult');
                const steps = ['Preparing withdrawal...', 'Submitting transaction...', 'Withdrawal complete'];
                createTransactionSteps('userActionsSteps', steps);
                updateTransactionText('userActionsProcessing', 'Preparing withdrawal...', 'Validating inputs and balances');
                updateTransactionStep('userActionsSteps', 0, 'active');

                // small pause for UX
                await new Promise(r => setTimeout(r, 400));

                updateTransactionText('userActionsProcessing', 'Submitting transaction...', 'Confirm in your wallet');
                updateTransactionStep('userActionsSteps', 0, 'completed');
                updateTransactionStep('userActionsSteps', 1, 'active');

                const result = await vaultIntegration.withdraw(shares);

                updateTransactionText('userActionsProcessing', 'Withdrawal complete', 'Funds will reflect shortly');
                updateTransactionStep('userActionsSteps', 1, 'completed');
                updateTransactionStep('userActionsSteps', 2, 'completed');

                // Show success with clickable hash
                showTransactionResult('userActionsResult', 'success',
                    `Successfully withdrew ${shares} shares!`,
                    `Transaction Hash: ${result.txHash}`);
                setTimeout(() => {
                    makeTransactionHashClickable('userActionsResultDetails', result.txHash);
                }, 100);

                document.getElementById('withdrawAmount').value = '';
                await loadVaultInfo();

                setTimeout(() => {
                    showTransactionProcessing('userActionsProcessing', false);
                }, 1500);

            } catch (error) {
                // Build a clearer error message and include tx hash if any
                let errorTitle = 'Withdrawal Failed';
                let errorDetails = '';
                const maybeHash = error?.hash || error?.transactionHash || error?.transaction?.hash;
                if (error?.code === 'CALL_EXCEPTION' || /estimateGas/i.test(error?.message || '')) {
                    errorDetails = 'Reverted during gas estimation. The transaction was not sent. Please check strategy allocations or try a smaller amount.';
                } else {
                    errorDetails = `Error: ${error?.shortMessage || error?.message || 'Unknown error'}`;
                }
                if (maybeHash) {
                    errorDetails += `\nTransaction Hash: ${maybeHash}`;
                }

                showTransactionResult('userActionsResult', 'error', errorTitle, errorDetails);
                showStatus(errorTitle + ': ' + (error?.shortMessage || error?.message || 'Unknown error'), 'error');
                showTransactionProcessing('userActionsProcessing', false);
                const resEl = document.getElementById('userActionsResult');
                if (resEl) resEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
            } finally {
                showLoading(false);
            }
        }

        async function investIdle() {
            if (!vaultIntegration) {
                showStatus('Please connect your wallet first', 'error');
                return;
            }

            try {
                // Show processing overlay for Manager Actions card
                showTransactionProcessing('managerActionsProcessing', true);
                hideTransactionResult('managerActionsResult');
                
                // Create transaction steps
                const steps = ['Preparing investment...', 'Investing in strategies...', 'Executing invest idle...', 'Investment complete'];
                createTransactionSteps('managerActionsSteps', steps);
                
                // Step 1: Preparing
                updateTransactionText('managerActionsProcessing', 'Preparing investment...', 'Analyzing idle funds and strategies');
                updateTransactionStep('managerActionsSteps', 0, 'active');
                
                // Small delay to show the step
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // Step 2: Investing in strategies
                updateTransactionText('managerActionsProcessing', 'Investing in strategies...', 'Deploying funds to Uniswap V3 and Aave strategies');
                updateTransactionStep('managerActionsSteps', 0, 'completed');
                updateTransactionStep('managerActionsSteps', 1, 'active');
                
                // Small delay to show the investing step
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Step 3: Executing (this will wait for MetaMask confirmation)
                updateTransactionText('managerActionsProcessing', 'Executing invest idle...', 'Investment transaction in progress');
                updateTransactionStep('managerActionsSteps', 1, 'completed');
                updateTransactionStep('managerActionsSteps', 2, 'active');
                
                const result = await vaultIntegration.investIdle();
                
                // Step 4: Complete
                updateTransactionText('managerActionsProcessing', 'Investment completed!', 'Successfully invested idle funds in strategies');
                updateTransactionStep('managerActionsSteps', 2, 'completed');
                updateTransactionStep('managerActionsSteps', 3, 'completed');

                // Show success result
                showTransactionResult('managerActionsResult', 'success', 
                    `Investment Successful!`, 
                    `Transaction Hash: ${result.txHash}`);
                
                // Make transaction hash clickable for copying
                setTimeout(() => {
                    makeTransactionHashClickable('managerActionsResultDetails', result.txHash);
                }, 100);
                
                await loadVaultInfo();
                
                // Hide processing after a delay
                setTimeout(() => {
                    showTransactionProcessing('managerActionsProcessing', false);
                }, 2000);

            } catch (error) {
                console.error('Invest idle error:', error);
                
                // Show error result
                showTransactionResult('managerActionsResult', 'error', 
                    'Investment Failed', 
                    `Error: ${error.message}`);
                
                // Hide processing overlay
                showTransactionProcessing('managerActionsProcessing', false);
            }
        }

        async function rebalanceStrategies() {
            console.log(' rebalanceStrategies function called');
            
            if (!vaultIntegration) {
                console.log(' vaultIntegration not available');
                showStatus('Please connect your wallet first', 'error');
                return;
            }

            console.log(' User role:', vaultIntegration.userRole);
            
            // Check if user has manager or keeper role
            let hasPermission = false;
            try {
                const isManager = await vaultIntegration.contracts.accessController.managers(vaultIntegration.userAddress);
                const isKeeper = await vaultIntegration.contracts.accessController.keepers(vaultIntegration.userAddress);
                console.log(' Role check - Manager:', isManager, 'Keeper:', isKeeper);
                
                // IndexSwap rebalance requires manager role specifically
                if (isManager) {
                    hasPermission = true;
                    console.log(' User has manager role for rebalancing');
                } else if (isKeeper) {
                    console.log(' User has keeper role but rebalance requires manager role');
                    showStatus('Rebalancing requires manager role. You have keeper role.', 'error');
                    return;
                } else {
                    console.log(' User has no special roles');
                    showStatus('Only managers can rebalance strategies', 'error');
                    return;
                }
            } catch (error) {
                console.error(' Failed to check user roles:', error);
                showStatus('Failed to verify user permissions', 'error');
                return;
            }
            
            if (!hasPermission) {
                console.log(' User does not have permission to rebalance');
                showStatus('Only managers can rebalance strategies', 'error');
                return;
            }

            try {
                // Show processing overlay for Manager Actions card
                showTransactionProcessing('managerActionsProcessing', true);
                hideTransactionResult('managerActionsResult');
                
                // Create transaction steps
                const steps = ['Analyzing allocations...', 'Calculating rebalance...', 'Executing rebalance...', 'Rebalance complete'];
                createTransactionSteps('managerActionsSteps', steps);
                
                // Step 1: Analyzing current allocations
                updateTransactionText('managerActionsProcessing', 'Analyzing current allocations...', 'Checking strategy balances and target allocations');
                updateTransactionStep('managerActionsSteps', 0, 'active');
                
                // Small delay to show the step
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // Step 2: Calculating rebalance requirements
                updateTransactionText('managerActionsProcessing', 'Calculating rebalance...', 'Determining optimal allocation adjustments');
                updateTransactionStep('managerActionsSteps', 0, 'completed');
                updateTransactionStep('managerActionsSteps', 1, 'active');
                
                // Small delay to show the calculating step
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Step 3: Executing rebalance
                updateTransactionText('managerActionsProcessing', 'Executing rebalance...', 'Please confirm in your wallet');
                updateTransactionStep('managerActionsSteps', 1, 'completed');
                updateTransactionStep('managerActionsSteps', 2, 'active');
                
                const result = await vaultIntegration.rebalanceStrategies();
                
                // Step 4: Complete
                if (result.success) {
                    updateTransactionText('managerActionsProcessing', 'Rebalance completed!', 'Strategies have been rebalanced successfully');
                    updateTransactionStep('managerActionsSteps', 2, 'completed');
                    updateTransactionStep('managerActionsSteps', 3, 'completed');

                    // Show success result
                    showTransactionResult('managerActionsResult', 'success', 
                        `Rebalance Successful!`, 
                        `Transaction Hash: ${result.txHash}`);
                    
                    // Make transaction hash clickable for copying
                    setTimeout(() => {
                        makeTransactionHashClickable('managerActionsResultDetails', result.txHash);
                    }, 100);
                    
                    // Refresh UI data
                    await loadVaultInfo();
                    
                    // Hide processing after a delay
                    setTimeout(() => {
                        showTransactionProcessing('managerActionsProcessing', false);
                    }, 2000);
                } else {
                    showStatus(result.message || 'Rebalance completed', 'success');
                    showTransactionProcessing('managerActionsProcessing', false);
                }
                
            } catch (error) {
                console.error('Rebalance error:', error);
                
                // Show error result
                showTransactionResult('managerActionsResult', 'error', 
                    'Rebalance Failed', 
                    `Error: ${error.message}`);
                
                // Hide processing overlay
                showTransactionProcessing('managerActionsProcessing', false);
            }
        }

        async function harvestAll() {
            if (!vaultIntegration) {
                showStatus('Please connect your wallet first', 'error');
                return;
            }

            try {
                showLoading(true);
                document.getElementById('harvestStatus').innerHTML = '<p style="color: #00d4ff;"> Harvesting strategies...</p>';
                
                const result = await vaultIntegration.harvestAll();

                document.getElementById('harvestStatus').innerHTML = `<p style="color: #28a745;"> Harvest successful! TX: ${result.txHash}</p>`;
                showStatus(`Successfully harvested all strategies! Transaction: ${result.txHash}`, 'success');
                await loadVaultInfo();

            } catch (error) {
                document.getElementById('harvestStatus').innerHTML = `<p style="color: #dc3545;"> Harvest failed: ${error.message}</p>`;
                showStatus('Harvest failed: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        async function setStrategy() {
            if (!vaultIntegration) {
                showStatus('Please connect your wallet first', 'error');
                return;
            }

            const strategyAddress = document.getElementById('strategyAddress').value;
            const allocationBps = document.getElementById('allocationBps').value;

            if (!strategyAddress || !allocationBps) {
                showStatus('Please enter strategy address and allocation', 'error');
                return;
            }

            try {
                showLoading(true);
                const result = await vaultIntegration.setStrategy(strategyAddress, allocationBps);

                showStatus(`Successfully set strategy! Transaction: ${result.txHash}`, 'success');
                document.getElementById('strategyAddress').value = '';
                document.getElementById('allocationBps').value = '';
                await loadVaultInfo();

            } catch (error) {
                showStatus('Set strategy failed: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }


        async function performSwap() {
            if (!vaultIntegration) {
                showStatus('Please connect your wallet first', 'error');
                return;
            }

            const fromToken = document.getElementById('swapFromToken').value;
            const toToken = document.getElementById('swapToToken').value;
            const amount = document.getElementById('swapAmount').value;

            if (!amount || amount <= 0) {
                showStatus('Please enter a valid swap amount', 'error');
                return;
            }

            if (fromToken === toToken) {
                showStatus('Please select different tokens for swapping', 'error');
                return;
            }

            try {
                // Show processing overlay for Swap card
                showTransactionProcessing('swapProcessing', true);
                hideTransactionResult('swapResult');
                
                // Create transaction steps
                const steps = ['Checking allowance...', 'Approving tokens...', 'Executing swap...', 'Transaction complete'];
                createTransactionSteps('swapSteps', steps);
                
                // Step 1: Check allowance
                updateTransactionText('swapProcessing', 'Preparing swap...', 'Checking token allowance');
                updateTransactionStep('swapSteps', 0, 'active');
                
                // Small delay to show the step
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // Step 2: Approve if needed
                updateTransactionText('swapProcessing', 'Approving tokens...', 'Setting token allowance for swap');
                updateTransactionStep('swapSteps', 0, 'completed');
                updateTransactionStep('swapSteps', 1, 'active');
                
                // Create a custom swap function that reports progress
                const result = await performSwapWithProgress(fromToken, toToken, amount);
                
                // Step 3: Swap executing
                updateTransactionText('swapProcessing', 'Executing swap...', 'Swap transaction in progress');
                updateTransactionStep('swapSteps', 1, 'completed');
                updateTransactionStep('swapSteps', 2, 'active');
                
                // Small delay to show the executing step
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                // Step 4: Complete
                updateTransactionText('swapProcessing', 'Swap completed!', 'Transaction successful');
                updateTransactionStep('swapSteps', 2, 'completed');
                updateTransactionStep('swapSteps', 3, 'completed');
                
                // Show success result
                showTransactionResult('swapResult', 'success', 
                    `Swap Successful!`, 
                    `Swapped ${result.amountSpent} ${fromToken} for ${result.amountReceived} ${toToken}`);
                
                // Make transaction hash clickable for copying
                setTimeout(() => {
                    makeTransactionHashClickable('swapResultDetails', result.txHash);
                }, 100);
                
                document.getElementById('swapAmount').value = '';
                await loadVaultInfo();
                
                // Hide processing after a delay
                setTimeout(() => {
                    showTransactionProcessing('swapProcessing', false);
                }, 2000);

            } catch (error) {
                console.error('Swap error:', error);
                
                // Show error result
                showTransactionResult('swapResult', 'error', 
                    'Swap Failed', 
                    `Error: ${error.message}`);
                
                // Hide processing overlay
                showTransactionProcessing('swapProcessing', false);
            }
        }

        // Custom swap function with progress tracking
        async function performSwapWithProgress(fromToken, toToken, amount) {
            // Check if vaultIntegration is properly initialized
            if (!vaultIntegration) {
                throw new Error('VaultIntegration not initialized. Please connect your wallet first.');
            }
            if (!vaultIntegration.signer) {
                throw new Error('Wallet not connected. Please connect your wallet first.');
            }
            if (!vaultIntegration.userAddress) {
                throw new Error('User address not available. Please reconnect your wallet.');
            }
            
            console.log('=== VAULT INTEGRATION STATUS ===');
            console.log('vaultIntegration exists:', !!vaultIntegration);
            console.log('vaultIntegration.signer exists:', !!vaultIntegration.signer);
            console.log('vaultIntegration.userAddress:', vaultIntegration.userAddress);
            console.log('vaultIntegration.CONTRACTS exists:', !!vaultIntegration.CONTRACTS);
            
            // Token addresses - AAVE/WETH system
            const AAVE_ADDRESS = vaultIntegration.CONTRACTS.asset;
            const WETH_ADDRESS = vaultIntegration.CONTRACTS.weth;
            const SWAP_ROUTER = vaultIntegration.CONTRACTS.newSwapRouter;
            const POOL_FEE = 500; // 0.05% fee tier

            // Determine token addresses
            let tokenIn, tokenOut, tokenInDecimals, tokenOutDecimals;
            if (fromToken === 'AAVE') {
                tokenIn = AAVE_ADDRESS;
                tokenOut = WETH_ADDRESS;
                tokenInDecimals = 18; // AAVE has 18 decimals
                tokenOutDecimals = 18;
            } else {
                tokenIn = WETH_ADDRESS;
                tokenOut = AAVE_ADDRESS;
                tokenInDecimals = 18;
                tokenOutDecimals = 18; // AAVE has 18 decimals
            }

            // Parse amount with correct decimals
            const amountIn = ethers.parseUnits(amount, tokenInDecimals);

            // Check balance and get initial balances
            console.log('=== SIGNER DEBUG ===');
            console.log('vaultIntegration.signer:', vaultIntegration.signer);
            console.log('vaultIntegration.signer type:', typeof vaultIntegration.signer);
            console.log('vaultIntegration.provider:', vaultIntegration.provider);
            console.log('vaultIntegration.provider type:', typeof vaultIntegration.provider);
            
            // Use provider for read-only operations if signer is not available
            const contractRunner = vaultIntegration.signer || vaultIntegration.provider;
            console.log('Using contractRunner:', contractRunner);
            
            const tokenInContract = new ethers.Contract(tokenIn, vaultIntegration.ABIS.erc20, contractRunner);
            const tokenOutContract = new ethers.Contract(tokenOut, vaultIntegration.ABIS.erc20, contractRunner);
            
            const balance = await tokenInContract.balanceOf(vaultIntegration.userAddress);
            const tokenOutBalanceBefore = await tokenOutContract.balanceOf(vaultIntegration.userAddress);

            if (balance < amountIn) {
                throw new Error(`Insufficient ${fromToken} balance. You have ${ethers.formatUnits(balance, tokenInDecimals)} ${fromToken}, trying to swap ${ethers.formatUnits(amountIn, tokenInDecimals)} ${fromToken}`);
            }

            // Check allowance
            const allowance = await tokenInContract.allowance(vaultIntegration.userAddress, SWAP_ROUTER);

            if (allowance < amountIn) {
                console.log('Setting allowance...');
                // Create a new contract instance with signer for write operations
                const tokenInContractWithSigner = new ethers.Contract(tokenIn, vaultIntegration.ABIS.erc20, vaultIntegration.signer);
                const approveTx = await tokenInContractWithSigner.approve(SWAP_ROUTER, amountIn);
                await approveTx.wait();
                console.log(' Allowance set');
            }

            // Create swap parameters
            const deadline = Math.floor(Date.now() / 1000) + 1200; // 20 minutes
            const swapParams = {
                tokenIn: tokenIn,
                tokenOut: tokenOut,
                fee: POOL_FEE,
                recipient: vaultIntegration.userAddress,
                deadline: deadline,
                amountIn: amountIn,
                amountOutMinimum: 0n,
                sqrtPriceLimitX96: 0n,
            };

            // Browser-compatible require for Uniswap artifact
            let artifact;
            try {
                if (typeof require !== 'undefined') {
                    artifact = require("@uniswap/swap-router-contracts/artifacts/contracts/SwapRouter02.sol/SwapRouter02.json");
                } else {
                    const response = await fetch('https://unpkg.com/@uniswap/swap-router-contracts@latest/artifacts/contracts/SwapRouter02.sol/SwapRouter02.json');
                    if (!response.ok) throw new Error('CDN load failed');
                    artifact = await response.json();
                }
            } catch (error) {
                artifact = {
                    abi: [
                        "function exactInputSingle((address tokenIn, address tokenOut, uint24 fee, address recipient, uint256 deadline, uint256 amountIn, uint256 amountOutMinimum, uint160 sqrtPriceLimitX96)) external payable returns (uint256 amountOut)"
                    ]
                };
            }
        
            const swapRouterInterface = new ethers.Interface(artifact.abi);

            // Encode the function call
            const calldata = swapRouterInterface.encodeFunctionData("exactInputSingle", [swapParams]);

            // Execute the swap
            console.log('Executing swap transaction...');
            const swapTx = await vaultIntegration.signer.sendTransaction({
                to: SWAP_ROUTER,
                data: calldata,
            });
            
            console.log('Swap transaction sent:', swapTx.hash);
            const receipt = await swapTx.wait();
            console.log('Swap transaction confirmed:', receipt.hash);

            if (receipt.status === 1) {
                console.log(' SUCCESS! Swap completed!');
                
                // Get new balances after transaction
                const newBalance = await tokenInContract.balanceOf(vaultIntegration.userAddress);
                const tokenOutBalanceAfter = await tokenOutContract.balanceOf(vaultIntegration.userAddress);

                // Calculate actual amounts
                const amountSpent = balance - newBalance;
                const actualAmountReceived = tokenOutBalanceAfter - tokenOutBalanceBefore;

                console.log(`${fromToken} balance before:`, ethers.formatUnits(balance, tokenInDecimals));
                console.log(`${fromToken} balance after:`, ethers.formatUnits(newBalance, tokenInDecimals));
                console.log(`${fromToken} spent:`, ethers.formatUnits(amountSpent, tokenInDecimals));
                
                console.log(`${toToken} balance before:`, ethers.formatUnits(tokenOutBalanceBefore, tokenOutDecimals));
                console.log(`${toToken} balance after:`, ethers.formatUnits(tokenOutBalanceAfter, tokenOutDecimals));
                console.log(`Actual ${toToken} received:`, ethers.formatUnits(actualAmountReceived, tokenOutDecimals));

                return {
                    success: true,
                    txHash: receipt.hash,
                    amountSpent: ethers.formatUnits(amountSpent, tokenInDecimals),
                    amountReceived: ethers.formatUnits(actualAmountReceived, tokenOutDecimals)
                };
            } else {
                throw new Error('Swap transaction reverted');
            }
        }

        // Transaction processing helper functions
        function showTransactionProcessing(processingId, show) {
            console.log(`showTransactionProcessing called: ${processingId}, show: ${show}`);
            
            // First, hide all processing overlays to ensure only one is active
            const allProcessingElements = document.querySelectorAll('.transaction-processing');
            console.log(`Found ${allProcessingElements.length} processing elements`);
            allProcessingElements.forEach(element => {
                element.classList.remove('active');
            });
            
            const processingElement = document.getElementById(processingId);
            console.log(`Processing element found:`, !!processingElement);
            if (processingElement) {
                if (show) {
                    processingElement.classList.add('active');
                    console.log(` Activated processing overlay: ${processingId}`);
                } else {
                    processingElement.classList.remove('active');
                    console.log(` Deactivated processing overlay: ${processingId}`);
                }
            } else {
                console.error(` Processing element not found: ${processingId}`);
                console.log('Available elements with "Processing" in ID:', 
                    Array.from(document.querySelectorAll('[id*="Processing"]')).map(el => el.id));
            }
        }

        function showTransactionResult(resultId, type, title, details) {
            const resultElement = document.getElementById(resultId);
            const detailsElement = document.getElementById(resultId + 'Details');
            
            if (resultElement && detailsElement) {
                // Remove existing type classes
                resultElement.classList.remove('success', 'error');
                // Add new type class
                resultElement.classList.add(type);
                
                // Update content
                const titleElement = resultElement.querySelector('.result-title');
                if (titleElement) {
                    titleElement.textContent = title;
                }
                detailsElement.textContent = details;
                
                // Show the result
                resultElement.classList.add('show');
            }
        }

        function hideTransactionResult(resultId) {
            const resultElement = document.getElementById(resultId);
            if (resultElement) {
                resultElement.classList.remove('show');
            }
        }

        function makeTransactionHashClickable(detailsId, txHash) {
            const detailsElement = document.getElementById(detailsId);
            if (detailsElement && txHash) {
                // Find the transaction hash in the text and make it clickable
                const text = detailsElement.textContent;
                const hashIndex = text.indexOf(txHash);
                
                if (hashIndex !== -1) {
                    const beforeHash = text.substring(0, hashIndex);
                    const afterHash = text.substring(hashIndex + txHash.length);
                    
                    // Create clickable hash element
                    const clickableHash = document.createElement('span');
                    clickableHash.textContent = txHash;
                    clickableHash.style.color = '#00d4ff';
                    clickableHash.style.cursor = 'pointer';
                    clickableHash.style.textDecoration = 'underline';
                    clickableHash.style.fontWeight = 'bold';
                    clickableHash.title = 'Click to copy transaction hash';
                    
                    // Add click event to copy hash
                    clickableHash.addEventListener('click', async () => {
                        try {
                            await navigator.clipboard.writeText(txHash);
                            
                            // Show temporary feedback
                            const originalText = clickableHash.textContent;
                            clickableHash.textContent = 'Copied!';
                            clickableHash.style.color = '#28a745';
                            
                            setTimeout(() => {
                                clickableHash.textContent = originalText;
                                clickableHash.style.color = '#00d4ff';
                            }, 1500);
                            
                        } catch (err) {
                            console.error('Failed to copy hash:', err);
                            // Fallback for older browsers
                            const textArea = document.createElement('textarea');
                            textArea.value = txHash;
                            document.body.appendChild(textArea);
                            textArea.select();
                            document.execCommand('copy');
                            document.body.removeChild(textArea);
                            
                            // Show feedback
                            const originalText = clickableHash.textContent;
                            clickableHash.textContent = 'Copied!';
                            clickableHash.style.color = '#28a745';
                            
                            setTimeout(() => {
                                clickableHash.textContent = originalText;
                                clickableHash.style.color = '#00d4ff';
                            }, 1500);
                        }
                    });
                    
                    // Replace the text content with clickable elements
                    detailsElement.innerHTML = '';
                    detailsElement.appendChild(document.createTextNode(beforeHash));
                    detailsElement.appendChild(clickableHash);
                    detailsElement.appendChild(document.createTextNode(afterHash));
                }
            }
        }

        // Step-by-step transaction progress functions
        function createTransactionSteps(stepsId, steps) {
            const stepsContainer = document.getElementById(stepsId);
            if (!stepsContainer) return;

            stepsContainer.innerHTML = '';
            
            steps.forEach((step, index) => {
                const stepElement = document.createElement('div');
                stepElement.className = 'transaction-step';
                stepElement.id = `${stepsId}_step_${index}`;
                
                stepElement.innerHTML = `
                    <div class="step-icon pending">${index + 1}</div>
                    <div class="step-text">${step}</div>
                `;
                
                stepsContainer.appendChild(stepElement);
            });
        }

        function updateTransactionStep(stepsId, stepIndex, status) {
            const stepElement = document.getElementById(`${stepsId}_step_${stepIndex}`);
            if (!stepElement) return;

            const iconElement = stepElement.querySelector('.step-icon');
            const textElement = stepElement.querySelector('.step-text');

            // Remove all status classes
            stepElement.classList.remove('active', 'completed');
            iconElement.classList.remove('pending', 'active', 'completed');
            textElement.classList.remove('active', 'completed');

            // Add new status class
            if (status === 'active') {
                stepElement.classList.add('active');
                iconElement.classList.add('active');
                textElement.classList.add('active');
            } else if (status === 'completed') {
                stepElement.classList.add('completed');
                iconElement.classList.add('completed');
                textElement.classList.add('completed');
                iconElement.textContent = '';
            }
        }

        function updateTransactionText(processingId, text, details = '') {
            const processingElement = document.getElementById(processingId);
            if (!processingElement) return;

            const textElement = processingElement.querySelector('.processing-text');
            const detailsElement = processingElement.querySelector('.processing-details');

            if (textElement) textElement.textContent = text;
            if (detailsElement && details) detailsElement.textContent = details;
        }

        function showStatus(message, type) {
            const statusDiv = document.createElement('div');
            statusDiv.className = `status ${type}`;
            statusDiv.textContent = message;
            
            const container = document.getElementById('statusMessages');
            container.appendChild(statusDiv);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (statusDiv.parentNode) {
                    statusDiv.parentNode.removeChild(statusDiv);
                }
            }, 5000);
        }

        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }

        // Refresh vault info every 30 seconds with visual indicator
        let refreshInterval;
        let isRefreshing = false;
        
        function startAutoRefresh() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
            
            refreshInterval = setInterval(async () => {
                if (vaultIntegration && !isRefreshing) {
                    isRefreshing = true;
                    console.log('Auto-refreshing vault data...');
                    
                    try {
                        // Show subtle refresh indicator
                        const statusElement = document.querySelector('.status');
                        if (statusElement) {
                            const originalText = statusElement.textContent;
                            statusElement.textContent = ' Refreshing data...';
                            statusElement.style.opacity = '0.7';
                            
                            await loadVaultInfo();
                            
                            // Restore original status after a short delay
                            setTimeout(() => {
                                statusElement.textContent = originalText;
                                statusElement.style.opacity = '1';
                            }, 1000);
                        } else {
                            await loadVaultInfo();
                        }
                    } catch (error) {
                        console.error('Auto-refresh error:', error);
                    } finally {
                        isRefreshing = false;
                    }
                }
            }, 30000);
        }
        
        // Start auto-refresh when wallet is connected
        function connectWalletWithAutoRefresh() {
            // Store original connectWallet function
            const originalConnectWallet = connectWallet;
            
            // Override connectWallet to start auto-refresh
            connectWallet = async function() {
                await originalConnectWallet();
                if (vaultIntegration) {
                    startAutoRefresh();
                }
            };
        }
        
        // Manual refresh function
        async function manualRefresh() {
            if (!vaultIntegration) {
                showStatus('Please connect your wallet first', 'error');
                return;
            }

            try {
                showStatus(' Refreshing data manually...', 'info');
                await loadVaultInfo();
                showStatus(' Data refreshed successfully!', 'success');
            } catch (error) {
                console.error('Manual refresh error:', error);
                showStatus(' Failed to refresh data: ' + error.message, 'error');
            }
        }

        // Initialize auto-refresh system
        connectWalletWithAutoRefresh();

        // --- Swap estimate preview ---
        async function updateSwapEstimate() {
            try {
                const estimateEl = document.getElementById('swapEstimate');
                if (!estimateEl) return;
                const from = document.getElementById('swapFromToken').value;
                const to = document.getElementById('swapToToken').value;
                const amountStr = document.getElementById('swapAmount').value;
                if (!amountStr || Number(amountStr) <= 0) { estimateEl.textContent = ''; return; }
                if (!vaultIntegration) { estimateEl.textContent = 'Connect wallet to preview.'; return; }

                // Get latest pool price
                const price = await vaultIntegration.getTokenPrice();
                if (!price) { estimateEl.textContent = ''; return; }
                const amt = Number(amountStr);
                let out = 0;
                if (from === 'AAVE' && to === 'WETH') {
                    // 1 WETH = X AAVE => 1 AAVE = 1/X WETH
                    const aavePerWeth = Number(price.wethToAave);
                    out = amt / aavePerWeth;
                    estimateEl.textContent = ` ${out.toFixed(6)} WETH (est.)`;
                } else if (from === 'WETH' && to === 'AAVE') {
                    const aavePerWeth = Number(price.wethToAave);
                    out = amt * aavePerWeth;
                    estimateEl.textContent = ` ${out.toFixed(6)} AAVE (est.)`;
                } else {
                    estimateEl.textContent = '';
                }
            } catch (e) {
                const estimateEl = document.getElementById('swapEstimate');
                if (estimateEl) estimateEl.textContent = '';
            }
        }

        // Wire-up estimate updates
        ['swapFromToken','swapToToken','swapAmount'].forEach(id => {
            const el = document.getElementById(id);
            if (el) {
                el.addEventListener('input', updateSwapEstimate);
                el.addEventListener('change', updateSwapEstimate);
            }
        });

        // Function to refresh strategy percentages
        async function refreshStrategyPercentages() {
            console.log(' refreshStrategyPercentages called');
            
            if (!vaultIntegration) {
                console.log(' VaultIntegration not initialized, skipping strategy percentages refresh');
                return;
            }

            try {
                console.log(' Calling vaultIntegration.getStrategyAllocations()...');
                const allocations = await vaultIntegration.getStrategyAllocations();
                console.log(' Allocations received:', allocations);
                
                const strategyPercentagesEl = document.getElementById('strategyPercentages');
                const strategyAllocationsEl = document.getElementById('strategyAllocations');
                
                // Update Rebalance Strategies section
                if (strategyPercentagesEl && allocations.strategies.length > 0) {
                    let html = '<div style="margin-bottom: 1rem;">';
                    
                    // Add total assets summary
                    html += `<div style="margin-bottom: 1rem; padding: 0.75rem; background: rgba(0,212,255,0.1); border-radius: 8px; border-left: 3px solid #00d4ff;">
                        <div style="font-weight: 600; color: #00d4ff; margin-bottom: 0.25rem;">Total Strategy Assets</div>
                        <div style="font-size: 1.1rem; color: #e8e8e8;">${allocations.totalAssets} AAVE</div>
                    </div>`;
                    
                    allocations.strategies.forEach((strategy, index) => {
                        const strategyName = strategy.address.toLowerCase().includes('6bde0781354858ba6344ab671b07663e89bff064') 
                            ? 'AaveV3 Strategy' 
                            : strategy.address.toLowerCase().includes('a33a3662d8750a90f14792b4908e95695b11e374')
                            ? 'UniswapV3 Strategy'
                            : `Strategy ${index + 1}`;
                        
                        // Calculate if strategy is over/under allocated
                        const diff = strategy.percentage - strategy.targetPercentage;
                        const diffColor = diff > 0 ? '#ff6b6b' : diff < 0 ? '#ffa726' : '#4caf50';
                        const diffText = diff > 0 ? `+${diff.toFixed(1)}%` : diff < 0 ? `${diff.toFixed(1)}%` : 'Balanced';
                        
                        html += `
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem; padding: 0.75rem; background: rgba(255,255,255,0.05); border-radius: 10px; border: 1px solid rgba(255,255,255,0.1);">
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; color: #e8e8e8; margin-bottom: 0.25rem;">${strategyName}</div>
                                    <div style="font-size: 0.75rem; color: rgba(255,255,255,0.5); word-break: break-all;">${strategy.address}</div>
                                </div>
                                <div style="text-align: right; min-width: 120px;">
                                    <div style="font-size: 1rem; color: #00d4ff; font-weight: 600; margin-bottom: 0.25rem;">${strategy.percentage.toFixed(2)}%</div>
                                    <div style="font-size: 0.85rem; color: rgba(255,255,255,0.7); margin-bottom: 0.25rem;">${strategy.assets} AAVE</div>
                                    <div style="font-size: 0.75rem; color: ${diffColor};">Target: ${strategy.targetPercentage}% (${diffText})</div>
                                </div>
                            </div>
                        `;
                    });
                    
                    html += '</div>';
                    strategyPercentagesEl.innerHTML = html;
                } else if (strategyPercentagesEl) {
                    strategyPercentagesEl.innerHTML = '<p style="color: rgba(255,255,255,0.6); text-align: center; padding: 1rem;"><em>No strategies configured</em></p>';
                }

                // Update Invest Idle Funds section
                if (strategyAllocationsEl && allocations.strategies.length > 0) {
                    let html = '<div style="margin-bottom: 1rem;">';
                    
                    allocations.strategies.forEach((strategy, index) => {
                        const strategyName = strategy.address.toLowerCase().includes('6bde0781354858ba6344ab671b07663e89bff064') 
                            ? 'AaveV3 Strategy' 
                            : strategy.address.toLowerCase().includes('a33a3662d8750a90f14792b4908e95695b11e374')
                            ? 'UniswapV3 Strategy'
                            : `Strategy ${index + 1}`;
                        
                        html += `
                            <div style="margin-bottom: 0.5rem; padding: 0.5rem; background: rgba(255,255,255,0.05); border-radius: 6px;">
                                <div style="font-weight: 600; color: #e8e8e8; margin-bottom: 0.25rem;">${strategyName}</div>
                                <div style="font-size: 0.8rem; color: #00d4ff; margin-bottom: 0.25rem;">${strategy.percentage.toFixed(2)}% (${strategy.assets} AAVE)</div>
                                <div style="font-size: 0.7rem; color: rgba(255,255,255,0.5); word-break: break-all;">${strategy.address}</div>
                            </div>
                        `;
                    });
                    
                    html += '</div>';
                    strategyAllocationsEl.innerHTML = html;
                } else if (strategyAllocationsEl) {
                    strategyAllocationsEl.innerHTML = '<p style="color: rgba(255,255,255,0.6); font-size: 0.85rem;"><em>No strategies configured</em></p>';
                }
                
            } catch (error) {
                console.error('Failed to refresh strategy percentages:', error);
                const strategyPercentagesEl = document.getElementById('strategyPercentages');
                const strategyAllocationsEl = document.getElementById('strategyAllocations');
                
                if (strategyPercentagesEl) {
                    strategyPercentagesEl.innerHTML = '<p style="color: #ff6b6b; text-align: center; padding: 1rem;"><em>Failed to load strategy data</em></p>';
                }
                if (strategyAllocationsEl) {
                    strategyAllocationsEl.innerHTML = '<p style="color: #ff6b6b; font-size: 0.85rem;"><em>Failed to load strategy data</em></p>';
                }
            }
        }

        // Function to refresh all manager UI data
        async function refreshManagerUI() {
            await loadVaultInfo();
            await refreshStrategyPercentages();
        }

        // Debug function to test contract connectivity
        async function debugContracts() {
            console.log(' DEBUG: Testing contract connectivity...');
            
            if (!window.vaultIntegration) {
                console.log(' vaultIntegration not available');
                return;
            }

            try {
                console.log(' Testing vault contract...');
                const vaultName = await window.vaultIntegration.contracts.vault.name();
                console.log(' Vault name:', vaultName);
                
                const strategiesLength = await window.vaultIntegration.contracts.vault.strategiesLength();
                console.log(' Strategies length:', strategiesLength.toString());
                
                for (let i = 0; i < strategiesLength; i++) {
                    const strategyAddress = await window.vaultIntegration.contracts.vault.strategies(i);
                    console.log(` Strategy ${i}:`, strategyAddress);
                    
                    const strategyContract = new ethers.Contract(strategyAddress, window.vaultIntegration.ABIS.strategy, window.vaultIntegration.signer || window.vaultIntegration.provider);
                    const assets = await strategyContract.totalAssets();
                    console.log(` Strategy ${i} assets:`, ethers.formatEther(assets), 'AAVE');
                }
                
                // Check user roles
                console.log(' Checking user roles...');
                console.log('User address:', window.vaultIntegration.userAddress);
                
                if (window.vaultIntegration.userAddress) {
                    const isManager = await window.vaultIntegration.contracts.accessController.managers(window.vaultIntegration.userAddress);
                    const isKeeper = await window.vaultIntegration.contracts.accessController.keepers(window.vaultIntegration.userAddress);
                    console.log(' User roles - Manager:', isManager, 'Keeper:', isKeeper);
                    
                    if (isManager) {
                        console.log(' User can rebalance (has manager role)');
                    } else if (isKeeper) {
                        console.log(' User has keeper role but rebalance requires manager role');
                    } else {
                        console.log(' User has no special roles');
                    }
                } else {
                    console.log(' No user address available');
                }
                
                console.log(' All contract tests passed');
            } catch (error) {
                console.error(' Contract test failed:', error);
            }
        }

        // Make debug function available globally for testing
        window.debugContracts = debugContracts;
        
        // Make refreshStrategyPercentages available globally for integration.js
        window.refreshStrategyPercentages = refreshStrategyPercentages;
        
        // Make loadVaultInfo available globally for integration.js
        window.loadVaultInfo = loadVaultInfo;
        
        // Function to force load all public data
        async function forceLoadPublicData() {
            console.log(' Force loading public data...');
            
            // Use global vaultIntegration
            const vi = window.vaultIntegration;
            
            if (!vi) {
                console.log(' vaultIntegration not available, trying to reinitialize...');
                try {
                    window.vaultIntegration = new VaultIntegration();
                    await window.vaultIntegration.initializeReadOnly();
                    console.log(' VaultIntegration reinitialized successfully');
                } catch (error) {
                    console.error(' Failed to reinitialize VaultIntegration:', error);
                    return;
                }
            }
            
            try {
                const currentVI = window.vaultIntegration;
                
                // Try to load vault info
                if (typeof loadVaultInfo === 'function') {
                    console.log(' Loading vault info...');
                    await loadVaultInfo();
                }
                
                // Try to load strategy percentages
                console.log(' Loading strategy percentages...');
                await refreshStrategyPercentages();
                
                // Try to load token prices
                if (typeof refreshTokenPrice === 'function') {
                    console.log(' Loading token prices...');
                    await refreshTokenPrice();
                }
                
                console.log(' Public data force loaded successfully');
            } catch (error) {
                console.error(' Failed to force load public data:', error);
            }
        }
        
        // Make forceLoadPublicData available globally
        window.forceLoadPublicData = forceLoadPublicData;
        
        // Simple fallback function to load strategy data directly
        async function loadStrategyDataDirectly() {
            console.log(' Loading strategy data directly...');
            
            try {
                // Use the same contract addresses as in the test file
                const VAULT_ADDRESS = "0x92EA77BA5Cd9b47EBe84e09A7b90b253F845eD11";
                const AAVE_STRATEGY_ADDRESS = "0x6bDE0781354858bA6344aB671B07663E89BFF064";
                const UNISWAP_STRATEGY_ADDRESS = "0xa33A3662d8750a90f14792B4908E95695b11E374";
                
                // Create provider with Alchemy RPC
                const provider = new ethers.JsonRpcProvider('https://eth-sepolia.g.alchemy.com/v2/jROdUKjJxmz2XYwNpS5Ik');
                
                // Create contracts
                const vaultContract = new ethers.Contract(VAULT_ADDRESS, [
                    "function totalAssets() external view returns (uint256)",
                    "function strategiesLength() external view returns (uint256)",
                    "function strategies(uint256) external view returns (address)"
                ], provider);
                
                const aaveStrategyContract = new ethers.Contract(AAVE_STRATEGY_ADDRESS, [
                    "function totalAssets() external view returns (uint256)"
                ], provider);
                
                const uniswapStrategyContract = new ethers.Contract(UNISWAP_STRATEGY_ADDRESS, [
                    "function totalAssets() external view returns (uint256)"
                ], provider);
                
                // Get strategy assets
                const aaveAssets = await aaveStrategyContract.totalAssets();
                const uniswapAssets = await uniswapStrategyContract.totalAssets();
                const totalAssets = aaveAssets + uniswapAssets;
                
                const aavePercentage = totalAssets > 0 ? (Number(aaveAssets) / Number(totalAssets)) * 100 : 0;
                const uniswapPercentage = totalAssets > 0 ? (Number(uniswapAssets) / Number(totalAssets)) * 100 : 0;
                
                console.log(' Strategy data loaded:', {
                    aaveAssets: ethers.formatEther(aaveAssets),
                    uniswapAssets: ethers.formatEther(uniswapAssets),
                    totalAssets: ethers.formatEther(totalAssets),
                    aavePercentage: aavePercentage.toFixed(2),
                    uniswapPercentage: uniswapPercentage.toFixed(2)
                });
                
                // Update the UI directly
                const strategyPercentagesEl = document.getElementById('strategyPercentages');
                const strategyAllocationsEl = document.getElementById('strategyAllocations');
                
                if (strategyPercentagesEl) {
                    const html = `
                        <div style="margin-bottom: 1rem;">
                            <div style="margin-bottom: 1rem; padding: 0.75rem; background: rgba(0,212,255,0.1); border-radius: 8px; border-left: 3px solid #00d4ff;">
                                <div style="font-weight: 600; color: #00d4ff; margin-bottom: 0.25rem;">Total Strategy Assets</div>
                                <div style="font-size: 1.1rem; color: #e8e8e8;">${ethers.formatEther(totalAssets)} AAVE</div>
                            </div>
                            
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem; padding: 0.75rem; background: rgba(255,255,255,0.05); border-radius: 10px; border: 1px solid rgba(255,255,255,0.1);">
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; color: #e8e8e8; margin-bottom: 0.25rem;">AaveV3 Strategy</div>
                                    <div style="font-size: 0.75rem; color: rgba(255,255,255,0.5); word-break: break-all;">${AAVE_STRATEGY_ADDRESS}</div>
                                </div>
                                <div style="text-align: right; min-width: 120px;">
                                    <div style="font-size: 1rem; color: #00d4ff; font-weight: 600; margin-bottom: 0.25rem;">${aavePercentage.toFixed(2)}%</div>
                                    <div style="font-size: 0.85rem; color: rgba(255,255,255,0.7); margin-bottom: 0.25rem;">${ethers.formatEther(aaveAssets)} AAVE</div>
                                    <div style="font-size: 0.75rem; color: #ff6b6b;">Target: 60% (+${(aavePercentage - 60).toFixed(1)}%)</div>
                                </div>
                            </div>
                            
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem; padding: 0.75rem; background: rgba(255,255,255,0.05); border-radius: 10px; border: 1px solid rgba(255,255,255,0.1);">
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; color: #e8e8e8; margin-bottom: 0.25rem;">UniswapV3 Strategy</div>
                                    <div style="font-size: 0.75rem; color: rgba(255,255,255,0.5); word-break: break-all;">${UNISWAP_STRATEGY_ADDRESS}</div>
                                </div>
                                <div style="text-align: right; min-width: 120px;">
                                    <div style="font-size: 1rem; color: #00d4ff; font-weight: 600; margin-bottom: 0.25rem;">${uniswapPercentage.toFixed(2)}%</div>
                                    <div style="font-size: 0.85rem; color: rgba(255,255,255,0.7); margin-bottom: 0.25rem;">${ethers.formatEther(uniswapAssets)} AAVE</div>
                                    <div style="font-size: 0.75rem; color: #ff6b6b;">Target: 40% (${(uniswapPercentage - 40).toFixed(1)}%)</div>
                                </div>
                            </div>
                        </div>
                    `;
                    strategyPercentagesEl.innerHTML = html;
                }
                
                if (strategyAllocationsEl) {
                    const html = `
                        <div style="margin-bottom: 1rem;">
                            <div style="margin-bottom: 0.5rem; padding: 0.5rem; background: rgba(255,255,255,0.05); border-radius: 6px;">
                                <div style="font-weight: 600; color: #e8e8e8; margin-bottom: 0.25rem;">AaveV3 Strategy</div>
                                <div style="font-size: 0.8rem; color: #00d4ff; margin-bottom: 0.25rem;">${aavePercentage.toFixed(2)}% (${ethers.formatEther(aaveAssets)} AAVE)</div>
                                <div style="font-size: 0.7rem; color: rgba(255,255,255,0.5); word-break: break-all;">${AAVE_STRATEGY_ADDRESS}</div>
                            </div>
                            <div style="margin-bottom: 0.5rem; padding: 0.5rem; background: rgba(255,255,255,0.05); border-radius: 6px;">
                                <div style="font-weight: 600; color: #e8e8e8; margin-bottom: 0.25rem;">UniswapV3 Strategy</div>
                                <div style="font-size: 0.8rem; color: #00d4ff; margin-bottom: 0.25rem;">${uniswapPercentage.toFixed(2)}% (${ethers.formatEther(uniswapAssets)} AAVE)</div>
                                <div style="font-size: 0.7rem; color: rgba(255,255,255,0.5); word-break: break-all;">${UNISWAP_STRATEGY_ADDRESS}</div>
                            </div>
                        </div>
                    `;
                    strategyAllocationsEl.innerHTML = html;
                }
                
                console.log(' Strategy data loaded and UI updated successfully');
                
                // Also load oracle prices
                console.log(' Loading oracle prices...');
                await loadOraclePrices();
                console.log(' Oracle prices loaded');
                
            } catch (error) {
                console.error(' Failed to load strategy data directly:', error);
            }
        }
        
        // Make loadStrategyDataDirectly available globally
        window.loadStrategyDataDirectly = loadStrategyDataDirectly;
        
        // Debounce timer for shares conversion
        let sharesConversionTimeout = null;
        
        // Function to update shares to assets conversion
        async function updateSharesToAssetsConversion() {
            // Clear existing timeout
            if (sharesConversionTimeout) {
                clearTimeout(sharesConversionTimeout);
            }
            
            // Debounce the conversion call
            sharesConversionTimeout = setTimeout(async () => {
                await performSharesToAssetsConversion();
            }, 300); // 300ms delay
        }
        
        // Actual conversion function
        async function performSharesToAssetsConversion() {
            const sharesInput = document.getElementById('withdrawAmount');
            const conversionDiv = document.getElementById('sharesToAssetsConversion');
            const convertedAssetsDiv = document.getElementById('convertedAssets');
            
            if (!sharesInput || !conversionDiv || !convertedAssetsDiv) {
                return;
            }
            
            const shares = sharesInput.value;
            
            // Hide conversion if no shares entered
            if (!shares || shares === '' || parseFloat(shares) <= 0) {
                conversionDiv.style.display = 'none';
                return;
            }
            
            try {
                // Show loading state
                conversionDiv.style.display = 'block';
                convertedAssetsDiv.textContent = 'Calculating...';
                
                // Get the conversion from vault contract
                if (window.vaultIntegration && window.vaultIntegration.contracts && window.vaultIntegration.contracts.vault) {
                    const sharesWei = ethers.parseEther(shares);
                    const assetsWei = await window.vaultIntegration.contracts.vault.convertToAssets(sharesWei);
                    const assetsFormatted = ethers.formatEther(assetsWei);
                    
                    convertedAssetsDiv.textContent = `${parseFloat(assetsFormatted).toFixed(6)} AAVE`;
                    conversionDiv.style.display = 'block';
                } else {
                    // Fallback: use direct contract call
                    const VAULT_ADDRESS = "0x92EA77BA5Cd9b47EBe84e09A7b90b253F845eD11";
                    const provider = new ethers.JsonRpcProvider('https://eth-sepolia.g.alchemy.com/v2/jROdUKjJxmz2XYwNpS5Ik');
                    
                    const vaultContract = new ethers.Contract(VAULT_ADDRESS, [
                        "function convertToAssets(uint256 shares) external view returns (uint256)"
                    ], provider);
                    
                    const sharesWei = ethers.parseEther(shares);
                    const assetsWei = await vaultContract.convertToAssets(sharesWei);
                    const assetsFormatted = ethers.formatEther(assetsWei);
                    
                    convertedAssetsDiv.textContent = `${parseFloat(assetsFormatted).toFixed(6)} AAVE`;
                    conversionDiv.style.display = 'block';
                }
                
            } catch (error) {
                console.error('Failed to convert shares to assets:', error);
                convertedAssetsDiv.textContent = 'Error calculating';
                conversionDiv.style.display = 'block';
            }
        }
        
        // Make updateSharesToAssetsConversion available globally
        window.updateSharesToAssetsConversion = updateSharesToAssetsConversion;
        
        // Oracle price functions
        async function loadOraclePrices() {
            try {
                console.log(' Loading oracle prices...');
                
                // Load actual price from Uniswap V3
                await loadActualPrice();
                
                // Load aggregator price from oracle
                await loadAggregatorPrice();
                
                console.log(' Oracle prices loaded successfully');
            } catch (error) {
                console.error(' Failed to load oracle prices:', error);
            }
        }
        
        async function loadActualPrice() {
            try {
                // Use correct Uniswap V3 pool address from integration.js
                const UNISWAP_V3_POOL_ADDRESS = "0x0E98753e483679703c902a0f574646d3653ad9eA"; // AAVE/WETH pool on Sepolia
                const provider = new ethers.JsonRpcProvider('https://eth-sepolia.g.alchemy.com/v2/jROdUKjJxmz2XYwNpS5Ik');
                
                console.log(' Loading actual price from pool:', UNISWAP_V3_POOL_ADDRESS);
                
                const poolContract = new ethers.Contract(UNISWAP_V3_POOL_ADDRESS, [
                    "function slot0() external view returns (uint160 sqrtPriceX96, int24 tick, uint16 observationIndex, uint16 observationCardinality, uint16 observationCardinalityNext, uint8 feeProtocol, bool unlocked)",
                    "function token0() external view returns (address)",
                    "function token1() external view returns (address)"
                ], provider);
                
                // Get pool info
                const [slot0, token0, token1] = await Promise.all([
                    poolContract.slot0(),
                    poolContract.token0(),
                    poolContract.token1()
                ]);
                
                const sqrtPriceX96 = slot0.sqrtPriceX96;
                console.log('sqrtPriceX96:', sqrtPriceX96.toString());
                console.log('token0:', token0);
                console.log('token1:', token1);
                
                // Check which token is which
                const AAVE_ADDRESS = "0x88541670E55cC00bEEFD87eB59EDd1b7C511AC9a";
                const WETH_ADDRESS = "0x4530fABea7444674a775aBb920924632c669466e";
                
                const isAaveToken0 = token0.toLowerCase() === AAVE_ADDRESS.toLowerCase();
                const isWethToken0 = token0.toLowerCase() === WETH_ADDRESS.toLowerCase();
                
                console.log(' DEBUG: Is AAVE token0?', isAaveToken0);
                console.log(' DEBUG: Is WETH token0?', isWethToken0);
                
                // Convert sqrtPriceX96 to actual price
                // Price = (sqrtPriceX96 / 2^96)^2
                const price = (Number(sqrtPriceX96) / Math.pow(2, 96)) ** 2;
                
                console.log(' DEBUG: sqrtPriceX96 raw:', sqrtPriceX96.toString());
                console.log(' DEBUG: sqrtPriceX96 number:', Number(sqrtPriceX96));
                console.log(' DEBUG: 2^96:', Math.pow(2, 96));
                console.log(' DEBUG: ratio before ^2:', Number(sqrtPriceX96) / Math.pow(2, 96));
                console.log(' DEBUG: price after ^2:', price);
                
                // The sqrtPriceX96 represents the price of token0 in terms of token1
                // We need to determine which token is which and calculate accordingly
                
                let wethToAave;
                if (isAaveToken0) {
                    // token0 = AAVE, token1 = WETH
                    // sqrtPriceX96 gives us: 1 AAVE = price WETH
                    // So: 1 WETH = 1/price AAVE
                    wethToAave = 1 / price;
                    console.log(' DEBUG: AAVE is token0, so 1 WETH =', wethToAave, 'AAVE');
                } else if (isWethToken0) {
                    // token0 = WETH, token1 = AAVE  
                    // sqrtPriceX96 gives us: 1 WETH = price AAVE
                    // So: 1 WETH = price AAVE (already correct)
                    wethToAave = price;
                    console.log(' DEBUG: WETH is token0, so 1 WETH =', wethToAave, 'AAVE');
                } else {
                    console.error(' Unknown token order!');
                    wethToAave = 1 / price; // fallback
                }
                
                console.log(' DEBUG: 1 WETH =', wethToAave, 'AAVE');
                
                document.getElementById('actualPrice').textContent = `${wethToAave.toFixed(6)} AAVE`;
                console.log(' Actual price loaded: 1 WETH =', wethToAave, 'AAVE');
                
            } catch (error) {
                console.error(' Failed to load actual price:', error);
                document.getElementById('actualPrice').textContent = 'Error loading';
            }
        }
        
        async function loadAggregatorPrice() {
            try {
                // Load from oracle module using correct address from integration.js
                const ORACLE_ADDRESS = "0x32D6d6024CE08930b1f3eDd30F5eDd0d1986c9c4"; // OracleModule address
                const AAVE_ADDRESS = "0x88541670E55cC00bEEFD87eB59EDd1b7C511AC9a"; // AAVE token on Sepolia
                const WETH_ADDRESS = "0x4530fABea7444674a775aBb920924632c669466e"; // WETH token
                
                const provider = new ethers.JsonRpcProvider('https://eth-sepolia.g.alchemy.com/v2/jROdUKjJxmz2XYwNpS5Ik');
                
                console.log(' Loading aggregator price from oracle:', ORACLE_ADDRESS);
                console.log('AAVE token address:', AAVE_ADDRESS);
                console.log('WETH token address:', WETH_ADDRESS);
                
                const oracleContract = new ethers.Contract(ORACLE_ADDRESS, [
                    "function price(address token) external view returns (uint256)"
                ], provider);
                
                // Get prices for both tokens (1e18 precision)
                const [aavePriceWei, wethPriceWei] = await Promise.all([
                    oracleContract.price(AAVE_ADDRESS),
                    oracleContract.price(WETH_ADDRESS)
                ]);
                
                console.log(' Raw AAVE price (wei):', aavePriceWei.toString());
                console.log(' Raw WETH price (wei):', wethPriceWei.toString());
                
                // Convert to readable format first
                const aavePriceFormatted = parseFloat(ethers.formatEther(aavePriceWei));
                const wethPriceFormatted = parseFloat(ethers.formatEther(wethPriceWei));
                
                console.log(' DEBUG: AAVE USD price:', aavePriceFormatted);
                console.log(' DEBUG: WETH USD price:', wethPriceFormatted);
                
                // Calculate using the same formula as your contract: ((amt18 * pToken) / pWant)
                // For 1 AAVE token: amt18 = 1e18, pToken = aavePrice, pWant = wethPrice
                // This gives us: how many WETH units 1 AAVE is worth
                const amt18 = ethers.parseEther("1"); // 1 AAVE token
                const valueInWant = (amt18 * aavePriceWei) / wethPriceWei;
                
                // Convert to readable format
                const valueInWantFormatted = parseFloat(ethers.formatEther(valueInWant));
                
                console.log(' DEBUG: 1 AAVE =', valueInWantFormatted, 'WETH');
                
                // Convert to "1 WETH = x AAVE" format
                const wethToAave = 1 / valueInWantFormatted; // If 1 AAVE = valueInWant WETH, then 1 WETH = 1/valueInWant AAVE
                
                console.log(' DEBUG: 1 WETH =', wethToAave, 'AAVE (oracle calculation)');
                console.log(' DEBUG: Oracle calculation breakdown:');
                console.log('  - AAVE USD price:', aavePriceFormatted);
                console.log('  - WETH USD price:', wethPriceFormatted);
                console.log('  - 1 AAVE in WETH:', valueInWantFormatted);
                console.log('  - 1 WETH in AAVE:', wethToAave);
                
                document.getElementById('aggregatorPrice').textContent = `${wethToAave.toFixed(6)} AAVE`;
                console.log(' Aggregator price calculated: 1 WETH =', wethToAave, 'AAVE');
                
                // Also show the USD equivalent if we want
                const aaveUsdPrice = ethers.formatEther(aavePriceWei);
                console.log(' AAVE USD price:', aaveUsdPrice);
                
            } catch (error) {
                console.error(' Failed to load aggregator price:', error);
                document.getElementById('aggregatorPrice').textContent = 'Error loading';
            }
        }
        
        
        async function setSqrtPrice() {
            try {
                console.log(' Calculating correct aaveEthAgg price to match sqrtPriceX96');
                
                if (!window.vaultIntegration || !window.vaultIntegration.signer) {
                    alert('Please connect your wallet first');
                    return;
                }
                
                // Get current sqrtPrice from Uniswap V3 pool
                const UNISWAP_V3_POOL_ADDRESS = "0x0E98753e483679703c902a0f574646d3653ad9eA";
                const ORACLE_ADDRESS = "0x32D6d6024CE08930b1f3eDd30F5eDd0d1986c9c4";
                const provider = new ethers.JsonRpcProvider('https://eth-sepolia.g.alchemy.com/v2/jROdUKjJxmz2XYwNpS5Ik');
                
                const oracleContract = new ethers.Contract(ORACLE_ADDRESS, [
                    "function price(address token) external view returns (uint256)"
                ], provider);
                
                const poolContract = new ethers.Contract(UNISWAP_V3_POOL_ADDRESS, [
                    "function slot0() external view returns (uint160 sqrtPriceX96, int24 tick, uint16 observationIndex, uint16 observationCardinality, uint16 observationCardinalityNext, uint8 feeProtocol, bool unlocked)",
                    "function token0() external view returns (address)",
                    "function token1() external view returns (address)"
                ], provider);
                
                const slot0 = await poolContract.slot0();
                const sqrtPriceX96 = slot0.sqrtPriceX96;
                
                // Use the EXACT same logic as loadActualPrice() function
                const [token0, token1] = await Promise.all([
                    poolContract.token0(),
                    poolContract.token1()
                ]);
                
                console.log('token0:', token0);
                console.log('token1:', token1);
                
                // Use EXACT same addresses as loadActualPrice()
                const AAVE_ADDRESS = "0x88541670E55cC00bEEFD87eB59EDd1b7C511AC9a";
                const WETH_ADDRESS = "0x4530fABea7444674a775aBb920924632c669466e";
                
                const isAaveToken0 = token0.toLowerCase() === AAVE_ADDRESS.toLowerCase();
                const isWethToken0 = token0.toLowerCase() === WETH_ADDRESS.toLowerCase();
                
                console.log(' DEBUG: Is AAVE token0?', isAaveToken0);
                console.log(' DEBUG: Is WETH token0?', isWethToken0);
                
                // Convert sqrtPriceX96 to actual price (EXACT same as loadActualPrice)
                const price = (Number(sqrtPriceX96) / Math.pow(2, 96)) ** 2;
                
                console.log(' DEBUG: sqrtPriceX96 raw:', sqrtPriceX96.toString());
                console.log(' DEBUG: price after ^2:', price);
                
                // EXACT same calculation as loadActualPrice()
                let wethToAave;
                if (isAaveToken0) {
                    // token0 = AAVE, token1 = WETH
                    // sqrtPriceX96 gives us: 1 AAVE = price WETH
                    // So: 1 WETH = 1/price AAVE
                    wethToAave = 1 / price;
                    console.log(' DEBUG: AAVE is token0, so 1 WETH =', wethToAave, 'AAVE');
                } else if (isWethToken0) {
                    // token0 = WETH, token1 = AAVE  
                    // sqrtPriceX96 gives us: 1 WETH = price AAVE
                    // So: 1 WETH = price AAVE (already correct)
                    wethToAave = price;
                    console.log(' DEBUG: WETH is token0, so 1 WETH =', wethToAave, 'AAVE');
                } else {
                    console.error(' Unknown token order!');
                    wethToAave = 1 / price; // fallback
                }
                
                console.log(' DEBUG: 1 WETH =', wethToAave, 'AAVE');
                
                // Convert the EXACT same value to 8 decimals
                const aaveEthAggValue8Decimals = Math.floor(wethToAave * 100000000);
                
                console.log(' DEBUG: Setting aaveEthAgg.answer to EXACT loadActualPrice value:', wethToAave, 'in 8 decimals:', aaveEthAggValue8Decimals);
                
                
                // MockAggregatorV3 addresses from your deployment
                const AAVE_ETH_AGG_ADDRESS = "0x3E2d029550FEb4884Aaa34F32d9cD916862B8f79";
                
                // First, let's check what functions are available and who can call them
                console.log(' Checking MockAggregatorV3 contract...');
                
                try {
                    // Try to read the current price first
                    const mockAggContract = new ethers.Contract(AAVE_ETH_AGG_ADDRESS, [
                        "function latestRoundData() external view returns (uint80 roundId, int256 answer, uint256 startedAt, uint256 updatedAt, uint80 answeredInRound)",
                        "function setAnswer(int256 a) external",
                        "function decimals() external view returns (uint8)"
                    ], window.vaultIntegration.signer);
                    
                    // Check current price
                    const currentData = await mockAggContract.latestRoundData();
                    console.log(' Current aaveEthAgg price:', currentData.answer.toString());
                    
                    // Check decimals
                    const decimals = await mockAggContract.decimals();
                    console.log(' MockAggregatorV3 decimals:', decimals.toString());
                    
                    // No access control check needed - anyone can call setAnswer()
                    
                    // Convert to int256 for the updateAnswer function (8 decimals)
                    const priceInt = BigInt(aaveEthAggValue8Decimals);
                    console.log(' Setting aaveEthAgg to:', priceInt.toString(), '(8 decimals)');
                    
                    // Estimate gas first
                    const gasEstimate = await mockAggContract.setAnswer.estimateGas(priceInt);
                    console.log(' Gas estimate:', gasEstimate.toString());
                    
                    const tx = await mockAggContract.setAnswer(priceInt);
                    await tx.wait();
                    
                } catch (contractError) {
                    console.error(' Contract interaction failed:', contractError);
                    
                    // Alternative approach: Try to configure the OracleModule directly
                    console.log(' Trying alternative approach: Configure OracleModule...');
                    
                    try {
                        const ORACLE_ADDRESS = "0x32D6d6024CE08930b1f3eDd30F5eDd0d1986c9c4";
                        const AAVE_ADDRESS = "0x88541670E55cC00bEEFD87eB59EDd1b7C511AC9a";
                        
                        const oracleContract = new ethers.Contract(ORACLE_ADDRESS, [
                            "function setTokenEthRoute(address token, address agg, bool invert, uint256 heartbeat) external",
                            "function owner() external view returns (address)"
                        ], window.vaultIntegration.signer);
                        
                        // Check if current user is oracle owner
                        const oracleOwner = await oracleContract.owner();
                        const currentAddress = await window.vaultIntegration.signer.getAddress();
                        
                        console.log(' OracleModule owner:', oracleOwner);
                        console.log(' Current signer:', currentAddress);
                        
                        if (oracleOwner.toLowerCase() !== currentAddress.toLowerCase()) {
                            throw new Error(`Only OracleModule owner can configure routes. Owner: ${oracleOwner}, Current user: ${currentAddress}`);
                        }
                        
                        // Configure the token/ETH route (assuming aaveEthAgg is already set up)
                        // This should already be configured, but we can verify
                        console.log(' OracleModule configuration should already be set up.');
                        console.log(' The issue might be with the MockAggregatorV3 access control.');
                        
                        throw new Error('MockAggregatorV3 update failed. Please check contract ownership and access controls.');
                        
                    } catch (oracleError) {
                        console.error(' OracleModule approach also failed:', oracleError);
                        throw contractError; // Throw the original error
                    }
                }
                
                showTransactionResult('oracleResult', 'success', 
                    ` Updated aaveEthAgg with EXACT loadActualPrice value!
                    
                    EXACT Uniswap V3: 1 WETH = ${wethToAave.toFixed(6)} AAVE
                    Set aaveEthAgg.answer to: ${aaveEthAggValue8Decimals} (8 decimals)
                    
                    Perfect sync with Uniswap V3!`);
                
                console.log(' aaveEthAgg updated to match sqrtPriceX96');
                
                // Refresh prices to show the updated values
                await loadAggregatorPrice();
                
            } catch (error) {
                console.error(' Failed to update aaveEthAgg:', error);
                showTransactionResult('oracleResult', 'error', ` Failed to update aaveEthAgg: ${error.message}`);
            }
        }
        
        // Function to refresh oracle prices
        async function refreshOraclePrices() {
            try {
                console.log(' Refreshing oracle prices...');
                await loadOraclePrices();
                showTransactionResult('oracleResult', 'success', ' Prices refreshed successfully!');
            } catch (error) {
                console.error(' Failed to refresh prices:', error);
                showTransactionResult('oracleResult', 'error', ` Failed to refresh prices: ${error.message}`);
            }
        }
        
        // Make oracle functions available globally
        window.loadOraclePrices = loadOraclePrices;
        window.setSqrtPrice = setSqrtPrice;
        window.refreshOraclePrices = refreshOraclePrices;
    </script>
    <script>
        // vaultIntegration is already declared above, just make it globally available
        window.vaultIntegration = null;
        
        async function initApp() {
            console.log('=== INITIALIZING APP ===');
            
            try {
                window.vaultIntegration = new VaultIntegration();
                console.log(' VaultIntegration instance created successfully');
                console.log('vaultIntegration object:', window.vaultIntegration);
            } catch (error) {
                console.error(' Failed to create VaultIntegration instance:', error);
                return;
            }
            
            // Initialize the vault integration (read-only mode first, then wallet if available)
            try {
                console.log(' Attempting initialization...');
                await window.vaultIntegration.initialize();
                console.log(' Initialization successful');
                
                // Test contracts immediately after initialization
                console.log(' Testing contracts after initialization...');
                await debugContracts();
                
                // Load all public data immediately
                console.log(' Loading public data...');
                await window.vaultIntegration.loadPublicData();
                console.log(' Public data loaded');
                
                // Load oracle prices
                console.log(' Loading oracle prices...');
                await loadOraclePrices();
                console.log(' Oracle prices loaded');
                
                // Force refresh strategy percentages after a short delay
                setTimeout(async () => {
                    console.log(' Force refreshing strategy percentages...');
                    try {
                        await refreshStrategyPercentages();
                        console.log(' Strategy percentages refreshed successfully');
                    } catch (error) {
                        console.error(' Failed to refresh strategy percentages:', error);
                    }
                }, 1000);
                
            } catch (error) {
                console.log(' Initialization failed:', error);
                console.log(' Continuing with limited functionality...');
                
                // Try direct strategy data loading as fallback
                try {
                    console.log(' Attempting direct strategy data loading...');
                    await loadStrategyDataDirectly();
                    console.log(' Direct strategy data loading successful');
                } catch (fallbackError) {
                    console.error(' Fallback loading also failed:', fallbackError);
                    showStatus('Some features may be limited. Connect wallet for full functionality.', 'warning');
                }
            }
            
            // Additional data loading after successful initialization (either read-only or wallet)
            try {
                if (typeof loadVaultInfo === 'function') {
                    try {
                        await loadVaultInfo();
                    } catch (error) {
                        console.error('loadVaultInfo failed:', error);
                    }
                }
                
                if (typeof refreshTokenPrice === 'function') {
                    try {
                        await refreshTokenPrice();
                    } catch (error) {
                        console.error('refreshTokenPrice failed:', error);
                    }
                }
                
                if (typeof refreshFeeEarnings === 'function') {
                    try {
                        await refreshFeeEarnings();
                    } catch (error) {
                        console.error('refreshFeeEarnings failed:', error);
                    }
                }
                
                if (typeof refreshStrategyPercentages === 'function') {
                    try {
                        console.log(' Calling refreshStrategyPercentages from initApp...');
                        // Add a small delay to ensure DOM is ready
                        await new Promise(resolve => setTimeout(resolve, 500));
                        await refreshStrategyPercentages();
                        console.log(' refreshStrategyPercentages completed successfully');
                    } catch (error) {
                        console.error(' refreshStrategyPercentages failed:', error);
                    }
                } else {
                    console.log(' refreshStrategyPercentages function not found');
                }
            } catch (error) {
                console.error(' VaultIntegration initialization failed:', error);
                console.log('Continuing with limited functionality...');
                
                // Try to load token prices and fee earnings even without wallet connection
                if (typeof refreshTokenPrice === 'function') {
                    try {
                        await refreshTokenPrice();
                    } catch (error) {
                        console.error('refreshTokenPrice failed:', error);
                    }
                }
                
                if (typeof refreshFeeEarnings === 'function') {
                    try {
                        await refreshFeeEarnings();
                    } catch (error) {
                        console.error('refreshFeeEarnings failed:', error);
                    }
                }
            }
        }
        
        // Final attempt to load all public data after everything is loaded
        setTimeout(async () => {
            console.log(' Final attempt to load all public data...');
            try {
                await forceLoadPublicData();
                console.log(' Final public data load completed');
            } catch (error) {
                console.error(' Final public data load failed:', error);
                console.log(' Trying direct strategy data loading as fallback...');
                try {
                    await loadStrategyDataDirectly();
                    console.log(' Direct strategy data loading completed');
                } catch (fallbackError) {
                    console.error(' Fallback loading also failed:', fallbackError);
                }
            }
        }, 3000); // Wait 3 seconds after everything is loaded
        
        window.addEventListener('DOMContentLoaded', initApp);
        
        // Also try to load data immediately when the page loads
        window.addEventListener('load', async () => {
            console.log(' Page fully loaded, attempting immediate data load...');
            
            // Try multiple times at different intervals to ensure data loads
            const loadAttempts = [500, 1500, 3000]; // 0.5s, 1.5s, 3s
            
            loadAttempts.forEach((delay, index) => {
                setTimeout(async () => {
                    console.log(` Attempt ${index + 1} to load strategy data...`);
                    try {
                        await loadStrategyDataDirectly();
                        console.log(` Attempt ${index + 1} completed successfully`);
                    } catch (error) {
                        console.log(` Attempt ${index + 1} failed:`, error.message);
                    }
                }, delay);
            });
        });

        // How to Use Modal Functions
        function openHowToUseModal() {
            document.getElementById('howToUseModal').style.display = 'block';
        }

        function closeHowToUseModal() {
            document.getElementById('howToUseModal').style.display = 'none';
        }

        // Close modal when clicking outside of it
        window.onclick = function(event) {
            const modal = document.getElementById('howToUseModal');
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        }
    </script>

    <!-- How to Use Modal -->
    <div id="howToUseModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3> How to Use Ardena Finance</h3>
                <span class="close" onclick="closeHowToUseModal()">&times;</span>
            </div>
            
            <div class="how-to-step">
                <h4> Getting Started</h4>
                <p>Ardena Finance is a DeFi yield vault that automatically optimizes your AAVE token investments across two strategies:</p>
                <ul>
                    <li><strong>AaveV3Strategy (60%):</strong> Conservative lending for stable returns</li>
                    <li><strong>UniswapV3Strategy (40%):</strong> High-yield liquidity provision</li>
                </ul>
            </div>

            <div class="how-to-step">
                <h4>1 Connect Your Wallet</h4>
                <p>Click "Connect Wallet" to link your MetaMask wallet to the platform. Make sure you're on the Ethereum Sepolia testnet.</p>
                <ul>
                    <li>Install MetaMask browser extension</li>
                    <li>Switch to Sepolia testnet</li>
                    <li>Get testnet ETH and AAVE tokens from faucets</li>
                </ul>
            </div>

            <div class="how-to-step">
                <h4>2 Get Testnet Tokens</h4>
                <p>You'll need testnet tokens to use the platform (these have no real value):</p>
                <ul>
                    <li><strong>Sepolia ETH:</strong> Use the Sepolia faucet for gas fees</li>
                    <li><strong>AAVE Tokens:</strong> Click "Mint AAVE Token" button to get test AAVE from Aave faucet</li>
                </ul>
            </div>

            <div class="how-to-step">
                <h4>3 Set Oracle Price (Important First Step)</h4>
                <p><strong> Before doing any trading or manager actions, ensure the oracle price is synced with Uniswap V3:</strong></p>
                <div class="info-note" style="background: rgba(255,193,7,0.1); border: 1px solid rgba(255,193,7,0.3); border-radius: 8px; padding: 12px; margin: 10px 0;">
                    <p style="margin: 0; color: #ffc107; font-size: 0.9rem;">
                        <strong> Why This Matters:</strong> The oracle determines accurate asset valuations for all vault operations. If prices are outdated or incorrect, deposits, withdrawals, and rebalancing may fail or give wrong results.
                    </p>
                </div>
                <ul>
                    <li><strong>Check Price Sync:</strong> Look at the "Set Oracle Price" card - compare "From Uniswap V3" vs "From Oracle Calculation"</li>
                    <li><strong>If Prices Don't Match:</strong> Click " Set Oracle Price" to sync the oracle with current Uniswap V3 prices</li>
                    <li><strong>Why It Happens:</strong> Oracle prices can become stale or incorrect due to network delays or manual updates</li>
                    <li><strong>When to Sync:</strong> Before deposits, withdrawals, rebalancing, or any manager actions</li>
                    <li><strong>Automatic Sync:</strong> In production, this will be automated by keeper bots</li>
                </ul>
            </div>

            <div class="how-to-step">
                <h4>4 Deposit AAVE Tokens</h4>
                <p>In the User Actions section:</p>
                <ul>
                    <li>Enter the amount of AAVE you want to deposit</li>
                    <li>Approve the transaction (first time only)</li>
                    <li>Confirm the deposit transaction</li>
                    <li>You'll receive vault shares representing your deposit</li>
                </ul>
            </div>

            <div class="how-to-step">
                <h4> Manager & Keeper Actions</h4>
                <p>For advanced operations like manager and keeper actions, use this specific address:</p>
                <div class="info-note" style="background: rgba(0,212,255,0.1); border: 1px solid rgba(0,212,255,0.3); border-radius: 8px; padding: 12px; margin: 10px 0;">
                    <p style="margin: 0; color: #00d4ff; font-size: 0.9rem;">
                        <strong> Production Note:</strong> In production environments, manager and keeper actions will be executed automatically by sophisticated bots and smart contracts, ensuring optimal performance and security without manual intervention.
                    </p>
                </div>
                <div class="highlight-box">
                    <h4> Test Address for Manager/Keeper Actions</h4>
                    <p><strong>Address:</strong> <code>0x73287306AF9460975938F6161EB823eD27BF7E5a</code></p>
                    <p><strong>Private Key:</strong> <code>e6219d95e56586caf054e7663a8c316b7699d01b4ada9b65565a4edcc5737bcb</code></p>
                    <p><strong> Important:</strong> This is a testnet-only address for demonstration purposes. Never use this private key on mainnet or with real funds.</p>
                </div>
                <ul>
                    <li>Import this private key into MetaMask for testing</li>
                    <li>Use this address to test manager and keeper functionalities</li>
                    <li>This address has the necessary permissions for advanced operations</li>
                    <li>Remember: This is for Sepolia testnet only!</li>
                </ul>
            </div>

            <div class="how-to-step">
                <h4>5 Invest Idle Funds (Managers Only)</h4>
                <p>If you're a manager, you can optimize fund allocation:</p>
                <ul>
                    <li>Click "Invest Idle Funds" to deploy funds to strategies</li>
                    <li>Monitor strategy allocations in Manager Actions</li>
                    <li>Funds are automatically split between Aave and Uniswap strategies</li>
                </ul>
            </div>

            <div class="how-to-step">
                <h4>6 Monitor Your Investment</h4>
                <p>Track your performance through various metrics:</p>
                <ul>
                    <li><strong>Your Assets:</strong> Current value of your vault shares</li>
                    <li><strong>Token Prices:</strong> Real-time AAVE/WETH exchange rates</li>
                    <li><strong>Fee Earnings:</strong> Trading fees and performance fees earned</li>
                    <li><strong>Strategy Allocations:</strong> How funds are distributed</li>
                </ul>
            </div>

            <div class="how-to-step">
                <h4>7 Withdraw Your Funds</h4>
                <p>When you want to exit your position:</p>
                <ul>
                    <li>Enter the number of vault shares to withdraw</li>
                    <li>Confirm the withdrawal transaction</li>
                    <li>Receive AAVE tokens back to your wallet</li>
                    <li>Withdrawals include your original deposit plus earned yields</li>
                </ul>
            </div>

            <div class="highlight-box">
                <h4> Pro Tips</h4>
                <ul>
                    <li>Always check oracle prices before major operations</li>
                    <li>Monitor strategy allocations to understand fund distribution</li>
                    <li>Use the test address for manager/keeper actions</li>
                    <li>Keep some ETH for gas fees</li>
                    <li>Check network status before large transactions</li>
                </ul>
            </div>
        </div>
    </div>
</body>
</html>
